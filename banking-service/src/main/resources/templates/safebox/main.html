<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/banking_base}">
<head>
    <title layout:fragment="title">Own Wedding Wallet - ì°¨ê³¡ì°¨ê³¡ê¸ˆê³ </title>

    <style layout:fragment="page-styles">
        /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
        .main-layout {
            display: flex;
            flex-direction: row;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ì‚¬ì´ë“œë°” (ì™¼ìª½) */
        .leftnav {
            width: 260px;
            flex-shrink: 0;
        }

        /* ë©”ì¸ ì»¨í…ì¸  (ì˜¤ë¥¸ìª½) */
        .container {
            flex: 1;
            max-width: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 32px 40px;
            box-shadow: 0 8px 25px rgba(200, 162, 200, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-sizing: border-box;
            max-width:600px;
            width: 100%;
            margin: 0 auto;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: #8b5a8c;
            margin-bottom: 25px;
            text-align: center;
        }

        /* ì„¸ì´í”„ë°•ìŠ¤/ì”ì•¡ ì •ë³´ */
        .balance-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            color: #a569a5;
            padding: 10px 0;
            border-bottom: 1px solid rgba(200, 162, 200, 0.3);
        }

        .balance-info:last-of-type {
            border-bottom: none;
            margin-bottom: 20px;
        }

        #balance, #savedAmount {
            font-size: 20px;
            font-weight: 600;
            color: #6b4c6b;
        }

        /* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin: 30px 0;
        }

        .slider-label {
            font-size: 24px;
            font-weight: 700;
            color: #6b4c6b;
        }

        #slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: #e1bee7;
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
        }

        #slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: #a569a5;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        #slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            background: #a569a5;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .step-buttons {
            display: flex;
            gap: 10px;
        }

        .step-buttons button {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid #c8a2c8;
            color: #8b5a8c;
            padding: 8px 15px;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .step-buttons button:hover {
            background: #e1bee7;
            color: #6b4c6b;
            border-color: #a569a5;
        }

        /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .submit-btn {
            width: 100%;
            padding: 14px 28px;
            border-radius: 25px;
            background: linear-gradient(135deg, #c8a2c8 0%, #a569a5 100%);
            color: white;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(165, 105, 165, 0.3);
            text-align: center;
            font-size: 16px;
            margin-top: 15px;
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #a569a5 0%, #8b5a8c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 90, 140, 0.4);
        }

        /* ì°¸ê³  ì‚¬í•­ */
        .note {
            font-size: 14px;
            color: #a569a5;
            text-align: center;
            line-height: 1.5;
            margin-top: 20px;
        }

        /* í¼ ê·¸ë£¹ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #8b5a8c;
        }

        .form-group input[type="number"],
        .form-group input[type="date"] {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e1bee7;
            background: rgba(255, 255, 255, 0.7);
            color: #6b4c6b;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #c8a2c8;
            box-shadow: 0 0 5px rgba(200, 162, 200, 0.5);
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-group label {
            font-weight: normal;
            color: #6b4c6b;
        }

        /* ì €ì¶• ëª©í‘œ ë¦¬ìŠ¤íŠ¸ */
        .goal-item {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(200, 162, 200, 0.3);
        }

        .goal-item h4 {
            margin: 0 0 10px 0;
            color: #6b4c6b;
            font-size: 18px;
        }

        .goal-item p {
            margin: 5px 0;
            color: #a569a5;
        }

        .goal-item button {
            margin-top: 10px;
            background: linear-gradient(135deg, #a569a5 0%, #8b5a8c 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .goal-item button:hover {
            background: #6b4c6b;
        }

        /* ë¡œë”© ìƒíƒœ í‘œì‹œ */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            .leftnav {
                width: 100%;
            }
            .container {
                width: 100%;
            }
            .card {
                padding: 24px 20px;
            }
            .section-title {
                font-size: 20px;
            }
            .balance-info {
                font-size: 14px;
            }
            #balance, #savedAmount {
                font-size: 18px;
            }
            .slider-label {
                font-size: 20px;
            }
            .step-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            .step-buttons button {
                flex-grow: 1;
            }
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 600px) {
            .step-buttons button {
                padding: 10px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <main class="site-content" layout:fragment="content">
        <div class="main-layout">

            <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
            <div th:replace="~{fragments/MainSideBar :: sidebar(
                ${userName}, 
                ${userEmail}, 
                ${totalAssets}, 
                ${safeboxBalance}, 
                ${goalPercent}, 
                'Main')}"></div>

            <!-- ì˜¤ë¥¸ìª½ ë³¸ë¬¸ -->
            <div class="container">
                <div class="card">
                    <div class="section-title">ì°¨ê³¡ì°¨ê³¡ê¸ˆê³  ì…ì¶œê¸ˆ</div>

                    <div class="balance-info">
                        <div>ë‚´ ì”ì•¡</div>
                        <div id="balance"
                            th:text="'â‚©' + ${#numbers.formatInteger(balance ?: 0, 3, 'COMMA')}">â‚©1,200,000</div>
                    </div>
                    <div class="balance-info">
                        <div>ì°¨ê³¡ì°¨ê³¡ê¸ˆê³ </div>
                        <div id="savedAmount"
                            th:text="'â‚©' + ${#numbers.formatInteger(safeboxBalance ?: 0, 3, 'COMMA')}">â‚©300,000</div>
                    </div>

                    <div class="slider-container">
                        <div class="slider-label" id="currentAmount">â‚©300,000</div>
                        <input type="range" id="slider" th:min="0"
                            th:max="${totalAssets ?: 1200000}" step="10000"
                            th:value="${safeboxBalance ?: 300000}" />
                        <div class="step-buttons">
                            <button onclick="adjust(-10000)">-1ë§Œ</button>
                            <button onclick="adjust(10000)">+1ë§Œ</button>
                        </div>
                    </div>

                    <button class="submit-btn" onclick="submitAmount()">ê¸ˆì•¡ ì„¤ì •í•˜ê¸°</button>

                    <div class="note">
                        ì°¨ê³¡ì°¨ê³¡ê¸ˆê³  í•´ì œ ì˜ˆì •ì¼: 2025.08.10<br /> ì¶œê¸ˆì€ í•´ì œì¼ ì´í›„ì— ê°€ëŠ¥í•©ë‹ˆë‹¤.
                    </div>
                </div>

                <div class="card">
                    <div class="section-title">ì •ê¸°ì €ê¸ˆí†µ ì„¤ì •</div>

                    <form id="autoSaveForm">
                        <div class="form-group">
                            <label>ëª©í‘œ ê¸ˆì•¡</label> 
                            <input type="number" id="goalAmount" name="goalAmount" placeholder="ì˜ˆ: 500000" required />
                        </div>

                        <div class="form-group">
                            <label>ì‹œì‘ì¼</label> 
                            <input type="date" id="startDate" name="startDate" required />
                        </div>

                        <div class="form-group">
                            <label>ì¢…ë£Œì¼ (ëª©í‘œ ë‹¬ì„±ì¼)</label> 
                            <input type="date" id="endDate" name="endDate" required />
                        </div>

                        <div class="form-group">
                            <label>ìë™ ì €ì¶• ì£¼ê¸°</label>
                            <div class="radio-group">
                                <label><input type="radio" name="cycle" value="daily" checked /> ë§¤ì¼</label> 
                                <label><input type="radio" name="cycle" value="monthly" /> ë§¤ì›”</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>ìë™ ì €ì¶• ê¸ˆì•¡</label> 
                            <input type="number" id="autoAmount" placeholder="ìë™ ê³„ì‚°ë¨" readonly />
                        </div>

                        <button class="submit-btn" type="submit">ì •ê¸°ì €ê¸ˆí†µ ì„¤ì •í•˜ê¸°</button>
                    </form>
                </div>

                <div class="card" th:if="${goals != null and !goals.isEmpty()}">
                    <div class="section-title">ë‚´ ì €ì¶• ëª©í‘œ</div>
                    <div th:each="goal : ${goals}" class="goal-item">
                        <h4 th:text="${goal.title}">ì €ì¶• ëª©í‘œ</h4>
                        <p>
                            ëª©í‘œ ê¸ˆì•¡: <span
                                th:text="'â‚©' + ${#numbers.formatInteger(goal.targetAmount, 3, 'COMMA')}">â‚©500,000</span>
                        </p>
                        <p>
                            ê¸°ê°„: <span th:text="${goal.startDate}">2025-01-01</span> ~ <span
                                th:text="${goal.endDate}">2025-12-31</span>
                        </p>
                        <p>
                            ì €ì¶• ì£¼ê¸°: <span th:text="${goal.paymentType == 'daily' ? 'ë§¤ì¼' : 'ë§¤ì›”'}">ë§¤ì¼</span>
                        </p>
                        <button th:onclick="|viewGoalDetail(${goal.goalId})|">ìƒì„¸ë³´ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div layout:fragment="scripts">
        <script src="/js/auth-buttons.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        
       <script th:inline="javascript">
        // JWTëŠ” ê²Œì´íŠ¸ì›¨ì´ì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ CSRF í† í° ë¶ˆí•„ìš”

        // jQuery AJAX ê¸°ë³¸ ì„¤ì • (CSRF ì—†ìŒ)
        $.ajaxSetup({
            xhrFields: {
                withCredentials: true
            }
        });

        // ğŸ’° ì„¸ì´í”„ë°•ìŠ¤ ë¡œì§
        const slider = document.getElementById("slider");
        const currentAmount = document.getElementById("currentAmount");
        const savedDisplay = document.getElementById("savedAmount");
        const balanceDisplay = document.getElementById("balance");

        function formatCurrency(value) {
          return 'â‚©' + value.toLocaleString();
        }

        // ì´ˆê¸°ê°’ ì„¤ì •
    const initialSafeboxBalance = /*[[${safeboxBalance}]]*/ 0;
    const totalAssets = /*[[${totalAssets}]]*/ 1200000;
    
        slider.value = initialSafeboxBalance;
        currentAmount.textContent = formatCurrency(initialSafeboxBalance);

        slider.addEventListener("input", () => {
          currentAmount.textContent = formatCurrency(Number(slider.value));
        });

        function adjust(amount) {
          let newValue = Number(slider.value) + amount;
          newValue = Math.min(Math.max(newValue, Number(slider.min)), Number(slider.max));
          slider.value = newValue;
          currentAmount.textContent = formatCurrency(newValue);
        }

        function submitAmount() {
          const amount = Number(slider.value);
          
          $.ajax({
            url: '/safebox/setAmount',
            type: 'POST',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            data: {
              amount: amount
            },
            success: function(response) {
              if (response.success) {
                savedDisplay.textContent = formatCurrency(response.safeboxBalance);
                balanceDisplay.textContent = formatCurrency(response.accountBalance);
                alert(response.message);
              } else {
                alert(response.message);
              }
            },
            error: function(xhr, status, error) {
              console.error('AJAX Error:', xhr.responseText);
              if (xhr.status === 401) {
                alert('ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = '/login';
              } else if (xhr.status === 403) {
                alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
              } else {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
              }
            }
          });
        }

        // ğŸ¯ ì •ê¸°ì €ê¸ˆí†µ ë¡œì§
        const goalInput = document.getElementById("goalAmount");
        const startDate = document.getElementById("startDate");
        const endDate = document.getElementById("endDate");
        const autoAmount = document.getElementById("autoAmount");

        function calculateAutoSaveAmount() {
          const goal = Number(goalInput.value);
          const start = new Date(startDate.value);
          const end = new Date(endDate.value);
          const cycle = document.querySelector('input[name="cycle"]:checked').value;

          if (!goal || !startDate.value || !endDate.value || start >= end) {
            autoAmount.value = '';
            return;
          }

          const msPerDay = 24 * 60 * 60 * 1000;
          const diffDays = Math.ceil((end - start) / msPerDay);
          const diffMonths = Math.ceil(diffDays / 30);

          let periods = cycle === 'daily' ? diffDays : diffMonths;
          if (periods <= 0) {
            autoAmount.value = '';
            return;
          }

          const perAmount = Math.ceil(goal / periods);
          autoAmount.value = perAmount;
        }

        goalInput.addEventListener("input", calculateAutoSaveAmount);
        startDate.addEventListener("change", calculateAutoSaveAmount);
        endDate.addEventListener("change", calculateAutoSaveAmount);
        document.querySelectorAll('input[name="cycle"]').forEach(radio => {
          radio.addEventListener("change", calculateAutoSaveAmount);
        });

        document.getElementById("autoSaveForm").addEventListener("submit", function (e) {
          e.preventDefault();
          
          const formData = {
            goalAmount: goalInput.value,
            startDate: startDate.value,
            endDate: endDate.value,
            cycle: document.querySelector('input[name="cycle"]:checked').value
          };

          $.ajax({
            url: '/safebox/createGoal',
            type: 'POST',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            data: formData,
            success: function(response) {
              if (response.success) {
                alert(response.message);
                location.reload();
              }
            },
            error: function(xhr, status, error) {
              console.error('AJAX Error:', xhr.responseText);
              if (xhr.status === 401) {
                alert('ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = '/login';
              } else if (xhr.status === 403) {
                alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
              } else {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
              }
            }
          });
        });

        function viewGoalDetail(goalId) {
          window.location.href = '/safebox/goal/' + goalId;
        }

        $(document).ready(function() {
          updateSafeboxInfo();
        });

        function updateSafeboxInfo() {
          $.ajax({
            url: '/safebox/info',
            type: 'GET',
            success: function(response) {
              if (response.success) {
                balanceDisplay.textContent = formatCurrency(response.accountBalance);
                savedDisplay.textContent = formatCurrency(response.safeboxBalance);
                slider.max = response.totalAssets;
              }
            },
            error: function() {
              console.log('ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          });
        }
        </script>
    </div>
</body>
</html>