<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wedding.oww.mapper.ProductMapper">

  <resultMap id="ProductMap" type="com.wedding.oww.vo.ProductVO">
    <id     property="productNo"   column="PRODUCT_NO"/>
    <result property="productName" column="PRODUCT_NAME"/>
    <result property="category"    column="CATEGORY"/>
    <result property="cost"        column="COST"/>
    <result property="address"     column="ADDRESS"/>
    <result property="description" column="DESCRIPTION"/>
    <result property="img"         column="IMG"/>
  </resultMap>

  <!-- <select id="findById" resultMap="ProductMap">
    SELECT * FROM PRODUCT WHERE PRODUCT_NO = #{productNo}
  </select> -->

  <select id="findForDIY" resultMap="ProductMap">
    SELECT *
    FROM PRODUCT
    <where>
      <if test="category != null">
        CATEGORY = #{category}
      </if>
      <if test="q != null and q != ''">
        <if test="category != null"> AND </if>
        ( LOWER(PRODUCT_NAME) LIKE '%' || LOWER(#{q}) || '%'
          OR LOWER(ADDRESS)     LIKE '%' || LOWER(#{q}) || '%'
          OR LOWER(DESCRIPTION) LIKE '%' || LOWER(#{q}) || '%'
        )
      </if>
    </where>
    <choose>
      <when test="sort == 'cost_asc'">  ORDER BY COST ASC, PRODUCT_NO DESC </when>
      <when test="sort == 'cost_desc'"> ORDER BY COST DESC, PRODUCT_NO DESC </when>
      <otherwise> ORDER BY PRODUCT_NO DESC </otherwise>
    </choose>
  </select>

  <!-- NEW: 다건 조회(IN). ids가 비면 이 쿼리는 호출하지 않도록 서비스에서 가드합니다. -->
  <!-- <select id="findByIds" resultMap="ProductMap">
    SELECT *
    FROM PRODUCT
    WHERE PRODUCT_NO IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select> -->

  <!-- 검색/정렬 -->
  <select id="search" resultMap="ProductMap">
    SELECT
      PRODUCT_NO, PRODUCT_NAME, CATEGORY, COST, ADDRESS, DESCRIPTION, IMG
    FROM PRODUCT
    <where>
      <if test="category != null">
        CATEGORY = #{category}
      </if>
      <if test="q != null and q != ''">
        <if test="category != null"> AND </if>
        (
          PRODUCT_NAME LIKE '%' || #{q} || '%'
          OR ADDRESS LIKE '%' || #{q} || '%'
          OR DESCRIPTION LIKE '%' || #{q} || '%'
        )
      </if>
    </where>
    <choose>
      <when test="sort == 'cost_asc'">
        ORDER BY COST ASC, PRODUCT_NO DESC
      </when>
      <when test="sort == 'cost_desc'">
        ORDER BY COST DESC, PRODUCT_NO DESC
      </when>
      <otherwise>
        ORDER BY PRODUCT_NO DESC
      </otherwise>
    </choose>
  </select>

  <!-- IN 절 조회 -->
  <select id="findByIds" resultMap="ProductMap">
    SELECT
      PRODUCT_NO, PRODUCT_NAME, CATEGORY, COST, ADDRESS, DESCRIPTION, IMG
    FROM PRODUCT
    <where>
      <if test="ids != null and ids.size() > 0">
        PRODUCT_NO IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
          #{id}
        </foreach>
      </if>
      <if test="ids == null or ids.size() == 0">
        1=0
      </if>
    </where>
  </select>

  <select id="findById" resultMap="ProductMap">
    SELECT PRODUCT_NO, PRODUCT_NAME, CATEGORY, COST, ADDRESS, DESCRIPTION, IMG
    FROM PRODUCT
    WHERE PRODUCT_NO = #{productNo}
  </select>

</mapper>
