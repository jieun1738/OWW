<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.LoanMapper">

  <!-- 공통 컬럼 -->
  <sql id="cols">
    application_id, user_email, product_name, amount, term_months,
    status, requested_at, decided_at, decided_by, memo
  </sql>

  <!-- 매핑 -->
  <resultMap id="LoanMap" type="com.example.demo.vo.LoanVO">
    <id     property="applicationId" column="application_id"/>
    <result property="userEmail"     column="user_email"/>
    <result property="productName"   column="product_name"/>
    <result property="amount"        column="amount"/>
    <result property="termMonths"    column="term_months"/>
    <result property="status"        column="status"/>
    <result property="requestedAt"   column="requested_at"/>
    <result property="decidedAt"     column="decided_at"/>
    <result property="decidedBy"     column="decided_by"/>
    <result property="memo"          column="memo"/>
  </resultMap>

  <!-- 목록 (필터+페이징) -->
  <select id="findAll" resultMap="LoanMap">
    SELECT <include refid="cols"/>
    FROM loan_application
    <where>
      <if test="status != null and status != ''">
        status = #{status}
      </if>
    </where>
    ORDER BY application_id DESC
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
  </select>

  <!-- 카운트 -->
  <select id="count" resultType="int">
    SELECT COUNT(*)
    FROM loan_application
    <where>
      <if test="status != null and status != ''">
        status = #{status}
      </if>
    </where>
  </select>

  <!-- 단건 조회 -->
  <select id="findById" resultMap="LoanMap">
    SELECT <include refid="cols"/>
    FROM loan_application
    WHERE application_id = #{id}
  </select>

  <!-- 승인 -->
  <update id="approve">
    UPDATE loan_application
       SET status     = 'APPROVED',
           decided_at = SYSDATE,
           decided_by = #{admin},
           memo       = #{memo}
     WHERE application_id = #{id}
  </update>

  <!-- 거절 -->
  <update id="reject">
    UPDATE loan_application
       SET status     = 'REJECTED',
           decided_at = SYSDATE,
           decided_by = #{admin},
           memo       = #{memo}
     WHERE application_id = #{id}
  </update>

</mapper>
