<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.ProductMapper">

  <resultMap id="ProductMap" type="com.example.demo.vo.ProductVO">
    <id     property="productNo"   column="product_no"/>
    <result property="productName" column="product_name"/>
    <result property="category"    column="category"/>
    <result property="cost"        column="cost"/>
    <result property="address"     column="address"/>
    <result property="img"         column="img"/>
    <result property="description" column="description"/>
  </resultMap>

  <sql id="cols"> <!-- SQL 재사용을 위해 컬럼 목록을 따로 정의 -->
    product_no, product_name, category, cost, address, img, description
  </sql>

  <select id="findAll" resultMap="ProductMap">
    SELECT <include refid="cols"/>
    FROM product
    <where>
      <if test="q != null and q != ''"> <!--  q 파라미터가 널이 아니라 빈 문자열이 안닐떄만 sql 실행 -->
        LOWER(product_name) LIKE '%'||LOWER(#{q})||'%'<!--  LOWER: 컬럼의 값을 항상 소문자로 변환 -> 대소문자 구뷴없는 검색가능 -->
      </if>
      <if test="category != null">
        AND category = #{category}
      </if>
    </where>
    ORDER BY product_no DESC
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
  </select>

<!-- 상품 개수 조회 -->
  <select id="count" resultType="int">
    SELECT COUNT(*) FROM product
    <where>
      <if test="q != null and q != ''">
        LOWER(product_name) LIKE '%'||LOWER(#{q})||'%'
      </if>
      <if test="category != null">
        AND category = #{category}
      </if>
    </where>
  </select>

<!-- 단일 상품 조회 -->
  <select id="findById" resultMap="ProductMap">
    SELECT <include refid="cols"/> FROM product WHERE product_no = #{id}
  </select>

<!-- 등록 -->
  <insert id="insert" parameterType="com.example.demo.vo.ProductVO">
    INSERT INTO product(product_no, product_name, category, cost, address, img, description)
    VALUES(#{productNo}, #{productName}, #{category}, #{cost}, #{address}, #{img}, #{description})
  </insert>

<!-- 수정 -->
  <update id="update" parameterType="com.example.demo.vo.ProductVO">
    UPDATE product SET
      product_name = #{productName},
      category     = #{category},
      cost         = #{cost},
      address      = #{address},
      img          = #{img},
      description  = #{description}
    WHERE product_no = #{productNo}
  </update>

<!-- 삭제 -->
  <delete id="delete">
    DELETE FROM product WHERE product_no = #{id}
  </delete>
</mapper>
