package com.oww.login.config;

import java.io.IOException;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

import org.springframework.security.core.Authentication;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.security.web.authentication.SimpleUrlAuthenticationSuccessHandler;
import org.springframework.stereotype.Component;

import com.oww.login.repository.UserRepository;
import com.oww.login.util.JwtUtil;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.Cookie;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

@Component
public class OAuth2LoginSuccessHandler extends SimpleUrlAuthenticationSuccessHandler {

	private final JwtUtil jwtUtil;
	private final UserRepository userRepository;

	public OAuth2LoginSuccessHandler(JwtUtil jwtUtil, UserRepository userRepository) {
		this.jwtUtil = jwtUtil;
		this.userRepository = userRepository;
	}

	@Override
	public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,
			Authentication authentication) throws IOException, ServletException {

		OAuth2User oAuth2User = (OAuth2User) authentication.getPrincipal();
		String email = oAuth2User.getAttribute("email");
		String name = oAuth2User.getAttribute("name");

		try {
			Long userNo = userRepository.findByEmailAndIsActiveTrue(email)
					.orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")).getUserNo();

			String jwtToken = jwtUtil.generateToken(userNo, name);
			String refreshToken = jwtUtil.generateRefreshToken(userNo, name);

			// í† í° ê¸¸ì´ ì²´í¬
			System.out.println("JWT í† í° ê¸¸ì´: " + jwtToken.length());
			if (jwtToken.length() > 4000) {
				System.err.println("ê²½ê³ : JWT í† í°ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤!");
			}

			// ì‘ë‹µ ì»¤ë°‹ ìƒíƒœ í™•ì¸
			if (response.isCommitted()) {
				System.err.println("ì‘ë‹µì´ ì´ë¯¸ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤!");
				return;
			}

			// ì¿ í‚¤ ìƒì„± ë° ì„¤ì •
			Cookie jwtCookie = createJwtCookie("jwt-token", jwtToken, 24 * 60 * 60);
			Cookie refreshCookie = createJwtCookie("refresh-token", refreshToken, 7 * 24 * 60 * 60);
			refreshCookie.setHttpOnly(true);

			response.addCookie(jwtCookie);
			response.addCookie(refreshCookie);

			// ì¿ í‚¤ ì„¤ì • í™•ì¸
			System.out.println("=== ì¿ í‚¤ ì„¤ì • ì™„ë£Œ ===");
			System.out.println(
					"JWT Cookie - Name: " + jwtCookie.getName() + ", Value length: " + jwtCookie.getValue().length());
			System.out.println(
					"Refresh Cookie - Name: " + refreshCookie.getName() + ", HttpOnly: " + refreshCookie.isHttpOnly());

			// ì‘ë‹µ í—¤ë” í™•ì¸
			System.out.println("Set-Cookie í—¤ë” ìˆ˜: " + response.getHeaders("Set-Cookie").size());
			for (String setCookieHeader : response.getHeaders("Set-Cookie")) {
				System.out.println("Set-Cookie: " + setCookieHeader);
			}
			// ë¦¬ë‹¤ì´ë ‰íŠ¸
			String redirectUrl = buildRedirectUrl("http://localhost:8201/", "login", "success");
			System.out.println("ë¦¬ë‹¤ì´ë ‰íŠ¸ URL: " + redirectUrl);

			getRedirectStrategy().sendRedirect(request, response, redirectUrl);

		} catch (Exception e) {
			System.err.println("ë¡œê·¸ì¸ ì²˜ë¦¬ ì‹¤íŒ¨: " + e.getMessage());
			e.printStackTrace();

			String errorUrl = buildRedirectUrl("http://localhost:8201/", "login", "error");
			getRedirectStrategy().sendRedirect(request, response, errorUrl);
		}
	}

	/**
	 * JWT ì¿ í‚¤ ìƒì„± ê³µí†µ ë©”ì„œë“œ
	 */
	private Cookie createJwtCookie(String name, String value, int maxAge) {
		Cookie cookie = new Cookie(name, value);
		cookie.setHttpOnly(false); // ê°œë°œí™˜ê²½: JSì—ì„œ ì½ê¸° ê°€ëŠ¥
		cookie.setPath("/"); // ëª¨ë“  ê²½ë¡œì—ì„œ ì‚¬ìš© ê°€ëŠ¥
		cookie.setMaxAge(maxAge);
		cookie.setSecure(false); // ê°œë°œí™˜ê²½: HTTPì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥
		// ğŸ”¥ í•µì‹¬: ë„ë©”ì¸ ì„¤ì •ìœ¼ë¡œ ëª¨ë“  localhost í¬íŠ¸ì—ì„œ ì¿ í‚¤ ê³µìœ 
		cookie.setDomain("localhost");

		// ê°œë°œí™˜ê²½ì—ì„œ SameSite ì„¤ì • (ì„ íƒì‚¬í•­)
		// ìµœì‹  ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì´ ì„¤ì •ì´ ì¤‘ìš”í•  ìˆ˜ ìˆìŒ

		System.out.println("ì¿ í‚¤ ìƒì„±: " + name + " (ë„ë©”ì¸: localhost, ê²½ë¡œ: /, MaxAge: " + maxAge + ")");

		return cookie;
	}

	/**
	 * ë¦¬ë‹¤ì´ë ‰íŠ¸ URL ìƒì„± (íŒŒë¼ë¯¸í„° í¬í•¨)
	 */
	private String buildRedirectUrl(String baseUrl, String paramName, String paramValue) {
		try {
			String encodedValue = URLEncoder.encode(paramValue, StandardCharsets.UTF_8.toString());
			return baseUrl + "?" + paramName + "=" + encodedValue;
		} catch (Exception e) {
			System.err.println("URL ì¸ì½”ë”© ì‹¤íŒ¨: " + e.getMessage());
			return baseUrl; // ê¸°ë³¸ URL ë°˜í™˜
		}
	}

	/**
	 * ë””ë²„ê·¸ ëª¨ë“œ í™•ì¸ (ê°œë°œí™˜ê²½ íŒë‹¨)
	 */
	private boolean isDebugMode() {
		// í™˜ê²½ë³€ìˆ˜ë‚˜ í”„ë¡œíŒŒì¼ë¡œ íŒë‹¨ ê°€ëŠ¥
		String profile = System.getProperty("spring.profiles.active", "dev");
		return "dev".equals(profile) || "local".equals(profile);
	}
}