// ========================================
// ê³„ì¢Œ ê´€ë ¨ í•¨ìˆ˜ë“¤
// ========================================

// ê³„ì¢Œ ì •ë³´ ë¡œë“œ
function loadAccountInfo() {
    // ë¡œë”© ìƒíƒœ í‘œì‹œ
    showLoadingState();
    
    fetch('http://localhost:8201/api/banking/account', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('ê³„ì¢Œ ì •ë³´ ë¡œë“œ ì„±ê³µ:', data);
        
        // ì¼ë°˜ ê³„ì¢Œ ì²˜ë¦¬
        handleAccountDisplay(data);
        
        // ì„¸ì´í”„ë°•ìŠ¤ ì²˜ë¦¬
        handleSafeboxDisplay(data);
        
        // ë¡œë”© ìƒíƒœ í•´ì œ
        hideLoadingState();
    })
    .catch(error => {
        console.error('ê³„ì¢Œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        handleAccountLoadError(error);
    });
}

// ê³„ì¢Œ í‘œì‹œ ì²˜ë¦¬
function handleAccountDisplay(data) {
    const accountCard = document.querySelector('.service-card:first-child');
    
    if (!accountCard) {
        console.error('ê³„ì¢Œ ì¹´ë“œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    if (data.hasAccount && data.accountNumber && data.balance !== undefined) {
        // ê³„ì¢Œ ìˆìŒ - ì‹¤ì œ ë°ì´í„° í‘œì‹œ
        updateAccountInfo(data.accountNumber, data.balance);
    } else {
        // ê³„ì¢Œ ì—†ìŒ - ìƒì„± ìœ ë„
        showCreateAccountPrompt();
    }
}

// ì„¸ì´í”„ë°•ìŠ¤ í‘œì‹œ ì²˜ë¦¬
function handleSafeboxDisplay(data) {
    const safeboxCard = document.querySelector('.service-card:nth-child(2)');
    
    if (!safeboxCard) {
        console.error('ì„¸ì´í”„ë°•ìŠ¤ ì¹´ë“œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    if (data.hasSafebox && data.safeboxBalance !== undefined) {
        // ì„¸ì´í”„ë°•ìŠ¤ ìˆìŒ
        updateSafeboxInfo(data.safeboxBalance);
    } else {
        // ì„¸ì´í”„ë°•ìŠ¤ ì—†ìŒ
        showCreateSafeboxPrompt();
    }
}

// ê³„ì¢Œ ì •ë³´ ì—…ë°ì´íŠ¸
function updateAccountInfo(accountNumber, balance) {
    const balanceElement = document.querySelector('.service-card:first-child .balance-amount');
    const accountNumberElement = document.querySelector('.service-card:first-child h2');
    
    if (balanceElement) {
        balanceElement.textContent = `â‚©${balance.toLocaleString()}`;
    }
    if (accountNumberElement) {
        accountNumberElement.textContent = accountNumber;
    }
}

// ì„¸ì´í”„ë°•ìŠ¤ ì •ë³´ ì—…ë°ì´íŠ¸
function updateSafeboxInfo(safeboxBalance) {
    const safeboxBalanceElement = document.querySelector('.service-card:nth-child(2) .balance-amount');
    
    if (safeboxBalanceElement) {
        safeboxBalanceElement.textContent = `â‚©${safeboxBalance.toLocaleString()}`;
    }
}

// ê³„ì¢Œ ìƒì„± ì•ˆë‚´ í‘œì‹œ
function showCreateAccountPrompt() {
    const accountCard = document.querySelector('.service-card:first-child');
    if (accountCard) {
        accountCard.innerHTML = `
            <div class="no-service-notice">
                <h2>ğŸ“­ ê³„ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤</h2>
                <p>Own Wedding Wallet ê³„ì¢Œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”</p>
                <button onclick="goToCreateAccount()" class="create-service-btn">
                    ê³„ì¢Œ ìƒì„±í•˜ê¸°
                </button>
            </div>
        `;
    }
}

// ì„¸ì´í”„ë°•ìŠ¤ ìƒì„± ì•ˆë‚´ í‘œì‹œ
function showCreateSafeboxPrompt() {
    const safeboxCard = document.querySelector('.service-card:nth-child(2)');
    if (safeboxCard) {
        safeboxCard.innerHTML = `
            <div class="no-service-notice">
                <h2>ğŸ”’ ì„¸ì´í”„ë°•ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</h2>
                <p>ì„¸ì´í”„ë°•ìŠ¤ë¥¼ ìƒì„±í•˜ì—¬ ì•ˆì „í•˜ê²Œ ìê¸ˆì„ ë³´ê´€í•˜ì„¸ìš”</p>
                <button onclick="goToCreateSafebox()" class="create-service-btn">
                    ì„¸ì´í”„ë°•ìŠ¤ ìƒì„±í•˜ê¸°
                </button>
            </div>
        `;
    }
}

// ë¡œë”© ìƒíƒœ í‘œì‹œ
function showLoadingState() {
    const serviceCards = document.getElementById('service-cards');
    if (serviceCards) {
        serviceCards.classList.add('loading');
        
        // ê° ì¹´ë“œì— ë¡œë”© í‘œì‹œ
        document.querySelectorAll('.service-card').forEach(card => {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-overlay';
            loadingDiv.innerHTML = '<div class="loading-spinner">ë¡œë”©ì¤‘...</div>';
            card.appendChild(loadingDiv);
        });
    }
}

// ë¡œë”© ìƒíƒœ í•´ì œ
function hideLoadingState() {
    const serviceCards = document.getElementById('service-cards');
    if (serviceCards) {
        serviceCards.classList.remove('loading');
        
        // ë¡œë”© ì˜¤ë²„ë ˆì´ ì œê±°
        document.querySelectorAll('.loading-overlay').forEach(overlay => {
            overlay.remove();
        });
    }
}

// ê³„ì¢Œ ë¡œë“œ ì—ëŸ¬ ì²˜ë¦¬
function handleAccountLoadError(error) {
    console.error('ê³„ì¢Œ ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
    hideLoadingState();
    
    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
    const serviceCards = document.getElementById('service-cards');
    if (serviceCards) {
        serviceCards.innerHTML = `
            <div class="error-notice">
                <h2>âš ï¸ ì„œë¹„ìŠ¤ ì—°ê²° ì˜¤ë¥˜</h2>
                <p>ê³„ì¢Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                <button onclick="loadAccountInfo()" class="retry-btn">
                    ë‹¤ì‹œ ì‹œë„
                </button>
            </div>
        `;
    }
}

// ê³„ì¢Œ ìƒì„± í˜ì´ì§€ë¡œ ì´ë™
function goToCreateAccount() {
    navigateToService('/banking/createAccount');
}

// ì„¸ì´í”„ë°•ìŠ¤ ìƒì„± í˜ì´ì§€ë¡œ ì´ë™
function goToCreateSafebox() {
    navigateToService('/banking/safebox');
}

// ì„œë¹„ìŠ¤ í˜ì´ì§€ ì´ë™ (ê³µí†µ í•¨ìˆ˜)
function navigateToService(path) {
    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    if (!isUserLoggedIn()) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        login();
        return;
    }
    
    window.location.href = path;
}

// ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ (auth.jsì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
function isUserLoggedIn() {
    // ì‹¤ì œ êµ¬í˜„ì€ auth.jsì˜ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë¡œì§ ì‚¬ìš©
    return localStorage.getItem('isLoggedIn') === 'true' || 
           sessionStorage.getItem('userToken') !== null;
}

// Banking ì„œë¹„ìŠ¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
function setupBankingButtons() {
    document.querySelectorAll('.banking-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const url = btn.dataset.url;
            const redirect = btn.dataset.redirect;
            
            if (!url || !redirect) {
                console.error('ë²„íŠ¼ì— í•„ìš”í•œ ë°ì´í„° ì†ì„±ì´ ì—†ìŠµë‹ˆë‹¤:', btn);
                return;
            }
            
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            if (!isUserLoggedIn()) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                login();
                return;
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'ì²˜ë¦¬ì¤‘...';
            
            fetch(url, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`ì¸ì¦ ì‹¤íŒ¨ (${response.status})`);
                }
                window.location.href = redirect;
            })
            .catch(error => {
                console.error('ë±…í‚¹ ì„œë¹„ìŠ¤ ì ‘ê·¼ ì‹¤íŒ¨:', error);
                alert(`ì„œë¹„ìŠ¤ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            })
            .finally(() => {
                // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
                btn.disabled = false;
                btn.textContent = originalText;
            });
        });
    });
}

// ê³„ì¢Œ ì •ë³´ ìƒˆë¡œê³ ì¹¨
function refreshAccountInfo() {
    console.log('ê³„ì¢Œ ì •ë³´ ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
    loadAccountInfo();
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', function() {
    // ë±…í‚¹ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
    setupBankingButtons();
    
    // ë¡œê·¸ì¸ëœ ìƒíƒœë¼ë©´ ê³„ì¢Œ ì •ë³´ ë¡œë“œ
    if (isUserLoggedIn()) {
        loadAccountInfo();
    }
});