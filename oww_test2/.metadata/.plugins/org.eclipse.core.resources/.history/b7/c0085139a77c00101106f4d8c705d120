package oww.banking.controller;

import java.util.HashMap;
import java.util.Map;
import java.util.Random;
import java.util.concurrent.ConcurrentHashMap;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import jakarta.servlet.http.HttpServletRequest;
import oww.banking.service.AccountService;
import oww.banking.service.EmailService;
import oww.banking.vo.AccountVO;

@Controller
public class BankingController {

    @Autowired
    private AccountService accountService;

    @Autowired
    private EmailService emailService;
    
    // âœ… ì„ì‹œ ì¸ì¦ë²ˆí˜¸ ì €ì¥ì†Œ (ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” Redis ì‚¬ìš© ê¶Œì¥)
    private static final Map<String, String> verificationCodes = new ConcurrentHashMap<>();
    private static final Map<String, Long> verificationTimestamps = new ConcurrentHashMap<>();
    private static final long VERIFICATION_EXPIRY_TIME = 10 * 60 * 1000; // 10ë¶„

    /**
     * âœ… Gateway í—¤ë”ì™€ SecurityContext ëª¨ë‘ í™œìš©í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ ì„¤ì •
     */
    private void addUserInfoToModel(Model model, HttpServletRequest request) {
        // 1ï¸. Gateway í—¤ë”ì—ì„œ ì§ì ‘ ì½ê¸° (ë” ì •í™•í•¨)
        String gatewayUserno = request.getHeader("X-User-No");
        String gatewayUsername = request.getHeader("X-Username");
        String gatewayUserRole = request.getHeader("X-User-Role");
        
        // 2ï¸. SecurityContextì—ì„œ ì½ê¸° (í•„í„°ì—ì„œ ì„¤ì •í•œ ê°’)
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        
        boolean isAuthenticated = false;
        String username = "Guest";
        String userRole = "GUEST";
        String userno = "0";
        String userEmail = null;

        // âœ… Gateway í—¤ë” ìš°ì„  ì‚¬ìš©
        if (gatewayUserno != null && gatewayUsername != null && gatewayUserRole != null) {
            userno = gatewayUserno;
            username = gatewayUsername;
            userRole = gatewayUserRole.replace("ROLE_", "");
            isAuthenticated = true;
            
            // ì´ë©”ì¼ì€ usernameìœ¼ë¡œ ê°€ì • (OAuth2ì˜ ê²½ìš° ì´ë©”ì¼ì´ usernameì¼ ê°€ëŠ¥ì„± ë†’ìŒ)
            if (username.contains("@")) {
                userEmail = username;
            }
            
            System.out.println("âœ… Gateway í—¤ë”ë¡œ ì‚¬ìš©ì ì¸ì¦: " + username + " (NO: " + userno + ")");
            
        } 
        // ğŸ”„ SecurityContext ë°±ì—… ì‚¬ìš©
        else if (auth != null && auth.isAuthenticated() && !"anonymousUser".equals(auth.getPrincipal())) {
            username = (String) auth.getPrincipal();
            userRole = auth.getAuthorities().iterator().next().getAuthority().replace("ROLE_", "");
            isAuthenticated = true;
            
            if (username.contains("@")) {
                userEmail = username;
            }
            
            System.out.println("ğŸ”„ SecurityContextë¡œ ì‚¬ìš©ì ì¸ì¦: " + username);
        } 
        // âŒ ì¸ì¦ ì‹¤íŒ¨
        else {
            System.out.println("âŒ ì‚¬ìš©ì ì¸ì¦ ì‹¤íŒ¨ - Gateway í—¤ë” ë° SecurityContext ëª¨ë‘ ì—†ìŒ");
        }

        // Modelì— ì‚¬ìš©ì ì •ë³´ ì¶”ê°€
        model.addAttribute("userNo", userno);
        model.addAttribute("userName", username);
        model.addAttribute("userEmail", userEmail);
        model.addAttribute("userRole", userRole);
        model.addAttribute("isAuthenticated", isAuthenticated);
    }

    /**
     * âœ… ì¸ì¦ë²ˆí˜¸ ìƒì„± ë©”ì„œë“œ
     */
    private String generateVerificationCode() {
        return String.format("%06d", new Random().nextInt(1000000));
    }

    /**
     * âœ… ì¸ì¦ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
     */
    private boolean isVerificationCodeValid(String email, String code) {
        String storedCode = verificationCodes.get(email);
        Long timestamp = verificationTimestamps.get(email);
        
        if (storedCode == null || timestamp == null) {
            return false;
        }
        
        // ë§Œë£Œ ì‹œê°„ í™•ì¸
        if (System.currentTimeMillis() - timestamp > VERIFICATION_EXPIRY_TIME) {
            verificationCodes.remove(email);
            verificationTimestamps.remove(email);
            return false;
        }
        
        return storedCode.equals(code);
    }

    /**
     * ë±…í‚¹ ë©”ì¸ í˜ì´ì§€
     */
    @GetMapping("/main")
    public String bankingMain(Model model, HttpServletRequest request) {
        System.out.println("ğŸ¦ Banking Main í˜¸ì¶œë¨");

        addUserInfoToModel(model, request);

        if ((Boolean) model.getAttribute("isAuthenticated")) {
            String userEmail = (String) model.getAttribute("userEmail");
            
            // ì‚¬ìš©ì ê³„ì¢Œ ì •ë³´ ì¡°íšŒ
            if (userEmail != null) {
                AccountVO account = accountService.getAccountByEmail(userEmail);
                if (account != null) {
                    model.addAttribute("accountBalance", String.format("%,dì›", account.getBalance()));
                    model.addAttribute("accountNumber", account.getAccountNumber()); // âœ… ê³„ì¢Œë²ˆí˜¸ ì‚¬ìš©
                    model.addAttribute("hasAccount", true);
                } else {
                    model.addAttribute("hasAccount", false);
                }
            }
            
            model.addAttribute("lastLogin", "2024-01-15 10:30");
        }

        return "banking_main";
    }

    /**
     * ê³„ì¢Œ ìƒì„± í˜ì´ì§€
     */
    @GetMapping("/createAccount")
    public String createAccount(Model model, HttpServletRequest request) {
        System.out.println("ğŸ¦ ê³„ì¢Œ ìƒì„± í˜ì´ì§€ í˜¸ì¶œë¨");

        addUserInfoToModel(model, request);

        if (!(Boolean) model.getAttribute("isAuthenticated")) {
            System.out.println("âŒ ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì - ë©”ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸");
            return "redirect:/main";
        }

        // ì´ë¯¸ ê³„ì¢Œê°€ ìˆëŠ”ì§€ í™•ì¸
        String userEmail = (String) model.getAttribute("userEmail");
        if (userEmail != null && accountService.isAccountExists(userEmail)) {
            model.addAttribute("errorMessage", "ì´ë¯¸ ê³„ì¢Œê°€ ì¡´ì¬í•©ë‹ˆë‹¤.");
            return "redirect:/main";
        }

        return "banking_createAccount";
    }

    /**
     * ê³„ì¢Œ ìƒì„± ì²˜ë¦¬
     */
    @PostMapping("/account/create")
    public String processCreateAccount(
            @RequestParam("name") String name,
            @RequestParam("email") String email,
            @RequestParam("password") String password,
            @RequestParam("emailCode") String emailCode,
            @RequestParam(value = "agree", required = false) String agree,
            Model model, 
            HttpServletRequest request) {

        System.out.println("ğŸ¦ ê³„ì¢Œ ìƒì„± ì²˜ë¦¬ í˜¸ì¶œë¨");

        addUserInfoToModel(model, request);

        if (!(Boolean) model.getAttribute("isAuthenticated")) {
            return "redirect:/main";
        }

        try {
            // 1. í•„ìˆ˜ í•„ë“œ ê²€ì¦
            if (name == null || name.trim().isEmpty()) {
                model.addAttribute("errorMessage", "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return "banking_createAccount";
            }


            if (email == null || !email.contains("@")) {
                model.addAttribute("errorMessage", "ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return "banking_createAccount";
            }

            if (String.valueOf(password).length() != 4) {
                model.addAttribute("errorMessage", "ê³„ì¢Œ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.");
                return "banking_createAccount";
            }

            if (emailCode == null || emailCode.trim().isEmpty()) {
                model.addAttribute("errorMessage", "ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return "banking_createAccount";
            }

            if (agree == null) {
                model.addAttribute("errorMessage", "ì•½ê´€ì— ë™ì˜í•´ì•¼ ê³„ì¢Œë¥¼ ê°œì„¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return "banking_createAccount";
            }

            // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì´ë©”ì¼ê³¼ ì…ë ¥í•œ ì´ë©”ì¼ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
            String userEmail = (String) model.getAttribute("userEmail");
            if (userEmail != null && !userEmail.equals(email)) {
                model.addAttribute("errorMessage", "ë¡œê·¸ì¸í•œ ê³„ì •ì˜ ì´ë©”ì¼ê³¼ ì…ë ¥í•œ ì´ë©”ì¼ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return "banking_createAccount";
            }

            // âœ… ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ í™•ì¸
            if (!isVerificationCodeValid(email, emailCode)) {
                model.addAttribute("errorMessage", "ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                return "banking_createAccount";
            }

            // 2. ê³„ì¢Œ ìƒì„± ì„œë¹„ìŠ¤ í˜¸ì¶œ
            String result = accountService.createAccount(name, email, password, emailCode);

            if (result.equals("ê³„ì¢Œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")) {
                // âœ… ì¸ì¦ë²ˆí˜¸ ì‚¬ìš© í›„ ì‚­ì œ
                verificationCodes.remove(email);
                verificationTimestamps.remove(email);
                
                model.addAttribute("successMessage", result);
                AccountVO newAccount = accountService.getAccountByEmail(email);
                model.addAttribute("newAccount", newAccount);
                return "account_success"; // ì„±ê³µ í˜ì´ì§€
            } else {
                model.addAttribute("errorMessage", result);
                return "banking_createAccount";
            }

        } catch (Exception e) {
            e.printStackTrace();
            model.addAttribute("errorMessage", "ê³„ì¢Œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            return "banking_createAccount";
        }
    }

    /**
     * âœ… ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ë°œì†¡ (Ajax) - EmailService ì§ì ‘ í˜¸ì¶œ
     */
    @PostMapping("/account/send-verification")
    @ResponseBody
    public ResponseEntity<Map<String, Object>> sendEmailVerification(
            @RequestParam("email") String email,
            HttpServletRequest request) {

        Map<String, Object> response = new HashMap<>();

        try {
            System.out.println("ğŸš¨ğŸš¨ğŸš¨ VERIFICATION_SEND_START ğŸš¨ğŸš¨ğŸš¨");
            System.out.println("ìš”ì²­ëœ ì´ë©”ì¼: " + email);

            // ì¸ì¦ í™•ì¸
            Model tempModel = new org.springframework.ui.ExtendedModelMap();
            addUserInfoToModel(tempModel, request);
            
            if (!(Boolean) tempModel.getAttribute("isAuthenticated")) {
                response.put("success", false);
                response.put("message", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(response);
            }

            // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬
            if (email == null || !email.contains("@")) {
                response.put("success", false);
                response.put("message", "ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return ResponseEntity.badRequest().body(response);
            }

            // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì´ë©”ì¼ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
            String userEmail = (String) tempModel.getAttribute("userEmail");
            if (userEmail != null && !userEmail.equals(email)) {
                response.put("success", false);
                response.put("message", "ë¡œê·¸ì¸í•œ ê³„ì •ì˜ ì´ë©”ì¼ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }

            // ì´ë¯¸ ê³„ì¢Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (accountService.isAccountExists(email)) {
                response.put("success", false);
                response.put("message", "ì´ë¯¸ ê³„ì¢Œê°€ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }

            // âœ… ì¸ì¦ë²ˆí˜¸ ìƒì„±
            String verificationCode = generateVerificationCode();
            String userName = (String) tempModel.getAttribute("userName");
            
            System.out.println("ìƒì„±ëœ ì¸ì¦ë²ˆí˜¸: " + verificationCode);
            System.out.println("ì‚¬ìš©ìëª…: " + userName);

            // âœ… EmailService ì§ì ‘ í˜¸ì¶œ
            emailService.sendVerificationEmail(email, verificationCode, userName);
            
            // âœ… ì¸ì¦ë²ˆí˜¸ ì„ì‹œ ì €ì¥
            verificationCodes.put(email, verificationCode);
            verificationTimestamps.put(email, System.currentTimeMillis());
            
            System.out.println("ğŸš¨ğŸš¨ğŸš¨ VERIFICATION_SEND_SUCCESS ğŸš¨ğŸš¨ğŸš¨");
            
            response.put("success", true);
            response.put("message", "ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.out.println("ğŸš¨ğŸš¨ğŸš¨ VERIFICATION_SEND_ERROR ğŸš¨ğŸš¨ğŸš¨");
            System.out.println("ì˜¤ë¥˜ íƒ€ì…: " + e.getClass().getSimpleName());
            System.out.println("ì˜¤ë¥˜ ë©”ì‹œì§€: " + e.getMessage());
            e.printStackTrace();
            
            response.put("success", false);
            response.put("message", "ì¸ì¦ë²ˆí˜¸ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage());
            return ResponseEntity.internalServerError().body(response);
        }
    }

    /**
     * âœ… ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ í™•ì¸ (Ajax) - ê°œì„ ëœ ê²€ì¦
     */
    @PostMapping("/account/verify-email")
    @ResponseBody
    public ResponseEntity<Map<String, Object>> verifyEmailCode(
            @RequestParam("email") String email,
            @RequestParam("code") String code,
            HttpServletRequest request) {

        Map<String, Object> response = new HashMap<>();

        try {
            // ì¸ì¦ í™•ì¸
            Model tempModel = new org.springframework.ui.ExtendedModelMap();
            addUserInfoToModel(tempModel, request);
            
            if (!(Boolean) tempModel.getAttribute("isAuthenticated")) {
                response.put("success", false);
                response.put("message", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(response);
            }

            // âœ… ì¸ì¦ë²ˆí˜¸ ê²€ì¦
            boolean isValid = isVerificationCodeValid(email, code);
            
            if (isValid) {
                response.put("success", true);
                response.put("message", "ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                response.put("success", false);
                response.put("message", "ì¸ì¦ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            e.printStackTrace();
            response.put("success", false);
            response.put("message", "ì¸ì¦ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            return ResponseEntity.internalServerError().body(response);
        }
    }

  

    /**
     * ê³„ì¢Œ ì¡°íšŒ (ì´ë©”ì¼ë¡œ)
     */
    @GetMapping("/account/info")
    @ResponseBody
    public ResponseEntity<AccountVO> getAccountInfo(
            @RequestParam("email") String email, 
            HttpServletRequest request) {
        try {
            // ì¸ì¦ í™•ì¸
            Model tempModel = new org.springframework.ui.ExtendedModelMap();
            addUserInfoToModel(tempModel, request);
            
            if (!(Boolean) tempModel.getAttribute("isAuthenticated")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
            }

            AccountVO account = accountService.getAccountByEmail(email);
            if (account != null) {
                // ë³´ì•ˆìƒ ë¹„ë°€ë²ˆí˜¸ëŠ” ì œì™¸í•˜ê³  ë°˜í™˜
                account.setAccountPassword("");
                return ResponseEntity.ok(account);
            } else {
                return ResponseEntity.notFound().build();
            }
        } catch (Exception e) {
            e.printStackTrace();
            return ResponseEntity.internalServerError().build();
        }
    }

    /**
     * ê³„ì¢Œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (Ajax)
     */
    @GetMapping("/account/exists")
    @ResponseBody
    public ResponseEntity<Map<String, Object>> checkAccountExists(
            @RequestParam("email") String email,
            HttpServletRequest request) {
        Map<String, Object> response = new HashMap<>();
        try {
            // ì¸ì¦ í™•ì¸
            Model tempModel = new org.springframework.ui.ExtendedModelMap();
            addUserInfoToModel(tempModel, request);
            
            if (!(Boolean) tempModel.getAttribute("isAuthenticated")) {
                response.put("error", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(response);
            }

            boolean exists = accountService.isAccountExists(email);
            response.put("exists", exists);
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            e.printStackTrace();
            response.put("error", "ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            return ResponseEntity.internalServerError().body(response);
        }
    }

    /**
     * ì„¸ì´í”„ë°•ìŠ¤ í˜ì´ì§€
     */
    @GetMapping("/safebox")
    public String safebox(Model model, HttpServletRequest request) {
        System.out.println("ğŸ¦ ì„¸ì´í”„ë°•ìŠ¤ í˜ì´ì§€ í˜¸ì¶œë¨");

        addUserInfoToModel(model, request);

        if (!(Boolean) model.getAttribute("isAuthenticated")) {
            return "redirect:/main";
        }

        return "banking_safebox";
    }

    /**
     * ì´ì²´ 1ë‹¨ê³„ í˜ì´ì§€
     */
    @GetMapping("/transfer_1")
    public String transfer1(Model model, HttpServletRequest request) {
        System.out.println("ğŸ¦ ì´ì²´ 1ë‹¨ê³„ í˜ì´ì§€ í˜¸ì¶œë¨");

        addUserInfoToModel(model, request);

        if (!(Boolean) model.getAttribute("isAuthenticated")) {
            return "redirect:/main";
        }

        // ì‚¬ìš©ì ê³„ì¢Œ ì •ë³´ ì¡°íšŒ
        String userEmail = (String) model.getAttribute("userEmail");
        if (userEmail != null) {
            AccountVO account = accountService.getAccountByEmail(userEmail);
            if (account != null) {
                model.addAttribute("userAccount", account);
            }
        }

        return "banking_transfer_1";
    }

    /**
     * ì´ì²´ 2ë‹¨ê³„ í˜ì´ì§€
     */
    @GetMapping("/transfer_2")
    public String transfer2(Model model, HttpServletRequest request) {
        System.out.println("ğŸ¦ ì´ì²´ 2ë‹¨ê³„ í˜ì´ì§€ í˜¸ì¶œë¨");

        addUserInfoToModel(model, request);

        if (!(Boolean) model.getAttribute("isAuthenticated")) {
            return "redirect:/main";
        }

        return "banking_transfer_2";
    }

    /**
     * ì´ì²´ 3ë‹¨ê³„ í˜ì´ì§€
     */
    @GetMapping("/transfer_3")
    public String transfer3(Model model, HttpServletRequest request) {
        System.out.println("ğŸ¦ ì´ì²´ 3ë‹¨ê³„ í˜ì´ì§€ í˜¸ì¶œë¨");

        addUserInfoToModel(model, request);

        if (!(Boolean) model.getAttribute("isAuthenticated")) {
            return "redirect:/main";
        }

        return "banking_transfer_3";
    }

    /**
     * í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ (ì¸ì¦ ë¶ˆí•„ìš”)
     */
    @GetMapping("/health")
    @ResponseBody
    public ResponseEntity<String> health() {
        return ResponseEntity.ok("Banking Service is running on port 8203");
    }

    /**
     * í™ˆí˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸
     */
    @GetMapping("/")
    public String home() {
        System.out.println("ğŸ  Home -> banking_main ë¦¬ë‹¤ì´ë ‰íŠ¸");
        return "redirect:/main";
    }

    /**
     * âœ… ê°œì„ ëœ ì‚¬ìš©ì ì •ë³´ API 
     */
    @GetMapping("/api/user-info")
    @ResponseBody
    public ResponseEntity<?> getUserInfo(HttpServletRequest request) {
        // Gateway í—¤ë” ì •ë³´
        String gatewayUserId = request.getHeader("X-User-Id");
        String gatewayUsername = request.getHeader("X-Username");
        String gatewayUserRole = request.getHeader("X-User-Role");
        
        // SecurityContext ì •ë³´
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        String securityUsername = "none";
        String securityRole = "none";
        boolean securityAuthenticated = false;

        if (auth != null && auth.isAuthenticated() && !"anonymousUser".equals(auth.getPrincipal())) {
            securityUsername = (String) auth.getPrincipal();
            securityRole = auth.getAuthorities().iterator().next().getAuthority();
            securityAuthenticated = true;
        }

        // ê³„ì¢Œ ì •ë³´ ì¶”ê°€
        Map<String, Object> accountInfo = new HashMap<>();
        if (gatewayUsername != null && gatewayUsername.contains("@")) {
            try {
                AccountVO account = accountService.getAccountByEmail(gatewayUsername);
                if (account != null) {
                    accountInfo.put("hasAccount", true);
                    accountInfo.put("accountNumber", account.getAccountNumber()); // âœ… ê³„ì¢Œë²ˆí˜¸ ì‚¬ìš©
                    accountInfo.put("balance", account.getBalance());
                } else {
                    accountInfo.put("hasAccount", false);
                }
            } catch (Exception e) {
                accountInfo.put("hasAccount", false);
                accountInfo.put("error", "ê³„ì¢Œ ì¡°íšŒ ì‹¤íŒ¨");
            }
        }

        return ResponseEntity.ok(
                java.util.Map.of(
                        "gateway", java.util.Map.of(
                                "userId", gatewayUserId != null ? gatewayUserId : "none",
                                "username", gatewayUsername != null ? gatewayUsername : "none",
                                "userRole", gatewayUserRole != null ? gatewayUserRole : "none"
                        ),
                        "security", java.util.Map.of(
                                "username", securityUsername,
                                "userRole", securityRole,
                                "authenticated", securityAuthenticated
                        ),
                        "finalAuth", java.util.Map.of(
                                "isAuthenticated", gatewayUserId != null && gatewayUsername != null,
                                "source", gatewayUserId != null ? "gateway" : (securityAuthenticated ? "security" : "none")
                        ),
                        "account", accountInfo,
                        "verification", java.util.Map.of(
                                "activeCodeCount", verificationCodes.size(),
                                "codes", verificationCodes.keySet() // ë””ë²„ê¹…ìš©
                        )
                )
        );
    }
}