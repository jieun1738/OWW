<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Own Wedding Wallet</title>
<link rel="stylesheet" href="/css/main.css" />
<style>
.welcome-modal {
	display: none;
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0,0,0,0.5);
	justify-content: center;
	align-items: center;
	z-index: 2000;
	text-align: center;
}
.welcome-modal.show { display: flex; }
.welcome-modal .modal-content {
	background: #fff;
	padding: 40px;
	border-radius: 20px;
	box-shadow: 0 20px 60px rgba(0,0,0,0.3);
	max-width: 400px;
	width: 90%;
	text-align: center;
	font-family: 'Noto Sans KR', 'Segoe UI', sans-serif;
}
.welcome-modal .modal-content button {
	margin-top: 20px;
	padding: 12px 30px;
	background: #ff726f;
	color: #fff;
	border: none;
	border-radius: 20px;
	cursor: pointer;
	font-weight: 600;
	transition: all 0.3s ease;
}
.welcome-modal .modal-content button:hover {
	background: #ff5a57;
	transform: translateY(-2px);
	box-shadow: 0 5px 15px rgba(255,114,111,0.3);
}
</style>
</head>
<body>
<div class="container">
	<header>
		<h1 class="logo">Own Wedding Wallet</h1>
		<div class="auth-section">
			<div id="logged-out-section" style="display: none;">
				<button onclick="login()" class="login-btn">ë¡œê·¸ì¸</button>
			</div>
			<div id="logged-in-section" style="display: none;">
				<span id="user-name-header">ì‚¬ìš©ìë‹˜</span>
				<button onclick="logout()" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
			</div>
		</div>
	</header>

	<nav>
		<div class="nav-item">
			<a href="/banking/main" class="nav-link banking-btn" data-url="http://localhost:8201/banking/main" data-redirect="/banking/main">ë±…í‚¹ì„œë¹„ìŠ¤</a>
			<div class="dropdown">
				<a href="/banking/createAccount" class="banking-btn" data-url="http://localhost:8201/banking/createAccount" data-redirect="/banking/createAccount">ê³„ì¢Œìƒì„±</a>
				<a href="/banking/transfer_1" class="banking-btn" data-url="http://localhost:8201/banking/transfer_1" data-redirect="/banking/transfer_1">ì´ì²´</a>
				<a href="/banking/safebox" class="banking-btn" data-url="http://localhost:8201/banking/safebox" data-redirect="/banking/safebox">ì„¸ì´í”„ë°•ìŠ¤</a>
			</div>
		</div>
		<div class="nav-item">
			<a href="#wedding" class="nav-link">ì›¨ë”©í”Œë˜ë„ˆ</a>
			<div class="dropdown">
				<a href="#">ì¶”ì²œí…Œë§ˆ</a>
				<a href="#">DIY</a>
			</div>
		</div>
		<div class="nav-item">
			<a href="#loan" class="nav-link">ëŒ€ì¶œ</a>
			<div class="dropdown">
				<a href="#">ëŒ€ì¶œìƒí’ˆ</a>
				<a href="#">ëŒ€ì¶œìƒí™˜</a>
			</div>
		</div>
		<div class="nav-item">
			<a href="#mypage" class="nav-link">ë§ˆì´í˜ì´ì§€</a>
		</div>
	</nav>

	<section id="login-notice" class="login-notice" style="display: none;">
		<div class="notice-card">
			<h2>ğŸ”’ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
			<p>Own Wedding Walletì˜ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì‹œë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
			<button onclick="login()" class="big-login-btn">Googleë¡œ ë¡œê·¸ì¸í•˜ê¸°</button>
		</div>
	</section>

	<section id="service-cards" class="service-cards" style="display: none;">
		<article class="service-card">
			<div class="service-card-left">
				<h1><span id="user-name-display">ì‚¬ìš©ì</span>ë‹˜ì˜ í†µì¥</h1>
				<h2>123-4567-89012</h2>
				<div class="balance-text">ì”ì•¡: <span class="balance-amount">â‚©1,234,567</span></div>
				<h3>ì´ë©”ì¼: <span id="user-email-display">user@example.com</span></h3>
			</div>
			<div class="service-card-right">
				<button class="history-btn banking-btn" data-url="http://localhost:8201/banking/transfer_1" data-redirect="/banking/transfer_1">ì´ì²´í•˜ê¸°</button>
				<button class="history-btn" onclick="alert('ë‚´ì—­ì¡°íšŒ ì¤€ë¹„ì¤‘')">ë‚´ì—­ì¡°íšŒ</button>
			</div>
		</article>

		<article class="service-card">
			<div class="service-card-left">
				<h1><span id="user-name-display2">ì‚¬ìš©ì</span>ë‹˜ì˜ ì„¸ì´í”„ë°•ìŠ¤</h1>
				<div class="balance-text">ì”ì•¡: <span class="balance-amount">â‚©5,000,000</span></div>
			</div>
			<div class="service-card-right">
				<button class="history-btn banking-btn" data-url="http://localhost:8201/banking/safebox" data-redirect="/banking/safebox">ê´€ë¦¬í•˜ê¸°</button>
			</div>
		</article>
	</section>

	<footer>&copy; 2025 Own Wedding Wallet. All rights reserved.</footer>
</div>

<div id="welcome-modal" class="welcome-modal">
	<div class="modal-content">
		<h2>ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
		<p><span id="modal-user-name">ì‚¬ìš©ì</span>ë‹˜, Own Wedding Walletì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.</p>
		<button onclick="closeWelcomeModal()">ì‹œì‘í•˜ê¸°</button>
	</div>
</div>

<script>
// UTF-8ë¡œ JWT ë””ì½”ë”©
function b64DecodeUnicode(str) {
    return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
}

// JWT ì¿ í‚¤ ì½ê¸°
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function deleteCookie(name) {
    document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/;';
}

// ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ
function checkLoginStatus() {
    const urlParams = new URLSearchParams(window.location.search);
    const loginSuccess = urlParams.get('login');

    if (loginSuccess) window.history.replaceState({}, document.title, window.location.pathname);

    const token = getCookie('jwt-token');
    if (token) {
        showLoggedInState();
        try {
            const payloadStr = b64DecodeUnicode(token.split('.')[1]);
            const payload = JSON.parse(payloadStr);
            const userName = payload.name || payload.username || 'ì‚¬ìš©ì';
            const userEmail = payload.email || payload.sub || 'user@example.com';
            updateUserInfo(userName, userEmail);
            if (loginSuccess === 'success') showWelcomeModal(userName);
        } catch(e) {
            console.error('JWT íŒŒì‹± ì˜¤ë¥˜:', e);
            updateUserInfo('ì‚¬ìš©ì', 'user@example.com');
        }
    } else {
        showLoggedOutState();
    }
}

function updateUserInfo(userName, userEmail) {
    document.getElementById('user-name-header').textContent = userName + 'ë‹˜';
    document.getElementById('user-name-display').textContent = userName;
    document.getElementById('user-name-display2').textContent = userName;
    document.getElementById('user-email-display').textContent = userEmail;
    document.getElementById('modal-user-name').textContent = userName;
}

function showLoggedInState() {
    document.getElementById('logged-out-section').style.display = 'none';
    document.getElementById('logged-in-section').style.display = 'flex';
    document.getElementById('login-notice').style.display = 'none';
    document.getElementById('service-cards').style.display = 'flex';
}

function showLoggedOutState() {
    document.getElementById('logged-out-section').style.display = 'block';
    document.getElementById('logged-in-section').style.display = 'none';
    document.getElementById('login-notice').style.display = 'block';
    document.getElementById('service-cards').style.display = 'none';
}

function showWelcomeModal(userName) {
    document.getElementById('welcome-modal').classList.add('show');
}

function closeWelcomeModal() {
    document.getElementById('welcome-modal').classList.remove('show');
}

// ë¡œê·¸ì¸ í•¨ìˆ˜ëŠ” ë‹¨ìˆœí•˜ê²Œ
function login() {
    window.location.href = '/auth/oauth2/authorization/google';
}

function logout() {
    deleteCookie('jwt-token');
    showLoggedOutState();
    updateUserInfo('ì‚¬ìš©ì', 'user@example.com');
}

// Banking ì„œë¹„ìŠ¤ ë²„íŠ¼ë§Œ fetch ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
    checkLoginStatus();
    
    // banking ì„œë¹„ìŠ¤ ë²„íŠ¼ë§Œ ì„ íƒ
    document.querySelectorAll('.banking-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const url = btn.dataset.url;
            const redirect = btn.dataset.redirect;
            
            fetch(url, {
                method: 'GET',
                credentials: 'include'
            })
            .then(res => {
                if (!res.ok) throw new Error('ì¸ì¦ í•„ìš”');
                window.location.href = redirect;
            })
            .catch(err => alert(err.message));
        });
    });
});

function checkLoginStatus() {
    const urlParams = new URLSearchParams(window.location.search);
    const loginSuccess = urlParams.get('login');

    if (loginSuccess) window.history.replaceState({}, document.title, window.location.pathname);

    const token = getCookie('jwt-token');
    if (token) {
        showLoggedInState();
        try {
            const payloadStr = b64DecodeUnicode(token.split('.')[1]);
            const payload = JSON.parse(payloadStr);
            const userName = payload.name || payload.username || 'ì‚¬ìš©ì';
            const userEmail = payload.email || payload.sub || 'user@example.com';
            updateUserInfo(userName, userEmail);
            
            // âœ… ê³„ì¢Œ ì •ë³´ ë¡œë“œ ì¶”ê°€!
            loadAccountInfo();
            
            if (loginSuccess === 'success') showWelcomeModal(userName);
        } catch(e) {
            console.error('JWT íŒŒì‹± ì˜¤ë¥˜:', e);
            updateUserInfo('ì‚¬ìš©ì', 'user@example.com');
        }
    } else {
        showLoggedOutState();
    }
}

// âœ… ìƒˆë¡œ ì¶”ê°€í•  í•¨ìˆ˜
function loadAccountInfo() {
    fetch('http://localhost:8201/api/banking/account', {
        method: 'GET',
        credentials: 'include'
    })
    .then(res => res.json())
    .then(data => {
        if (data.hasAccount) {
            // ê³„ì¢Œ ìˆìŒ - ì‹¤ì œ ë°ì´í„° í‘œì‹œ
            document.querySelector('.service-card:first-child .balance-amount').textContent = 
                `â‚©${data.balance.toLocaleString()}`;
            document.querySelector('.service-card:first-child h2').textContent = 
                data.accountNumber;
        } else {
            // ê³„ì¢Œ ì—†ìŒ - ìƒì„± ìœ ë„
            document.querySelector('.service-card:first-child').innerHTML = `
                <div style="text-align: center; padding: 30px; width: 100%;">
                    <h2>ğŸ“­ ê³„ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤</h2>
                    <p style="margin: 15px 0; color: #666;">
                        Own Wedding Wallet ê³„ì¢Œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”
                    </p>
                    <button onclick="goToCreateAccount()" 
                            style="padding: 12px 30px; 
                                   background: #ff726f; 
                                   color: white; 
                                   border: none; 
                                   border-radius: 20px; 
                                   cursor: pointer;">
                        ê³„ì¢Œ ìƒì„±í•˜ê¸°
                    </button>
                </div>
            `;
        }
        
        // ì„¸ì´í”„ë°•ìŠ¤ë„ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
        if (data.hasSafebox) {
            document.querySelector('.service-card:nth-child(2) .balance-amount').textContent = 
                `â‚©${data.safeboxBalance.toLocaleString()}`;
        } else {
            document.querySelector('.service-card:nth-child(2)').innerHTML = `
                <div style="text-align: center; padding: 30px; width: 100%;">
                    <h2>ğŸ”’ ì„¸ì´í”„ë°•ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</h2>
                    <p style="margin: 15px 0; color: #666;">
                        ì„¸ì´í”„ë°•ìŠ¤ë¥¼ ìƒì„±í•˜ì—¬ ì•ˆì „í•˜ê²Œ ìê¸ˆì„ ë³´ê´€í•˜ì„¸ìš”
                    </p>
                    <button onclick="goToCreateSafebox()" 
                            style="padding: 12px 30px; 
                                   background: #ff726f; 
                                   color: white; 
                                   border: none; 
                                   border-radius: 20px; 
                                   cursor: pointer;">
                        ì„¸ì´í”„ë°•ìŠ¤ ìƒì„±í•˜ê¸°
                    </button>
                </div>
            `;
        }
    })
    .catch(err => {
        console.error('ê³„ì¢Œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', err);
    });
}

// âœ… í˜ì´ì§€ ì´ë™ í•¨ìˆ˜ë“¤
function goToCreateAccount() {
    window.location.href = '/banking/createAccount';
}

function goToCreateSafebox() {
    window.location.href = '/banking/safebox';
}
</script>
</body>
</html>