package oww.banking.service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Random;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import oww.banking.mapper.AccountMapper;
import oww.banking.vo.AccountVO;
import oww.banking.vo.UserVO;

@Service
@Transactional
public class AccountService {

    @Autowired
    private AccountMapper accountMapper;

    @Autowired
    private EmailService emailService;

    // ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ì €ì¥ìš© (ì‹¤ì œë¡œëŠ” Redisë‚˜ DBì— ì €ì¥í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ)
    private Map<String, String> emailVerificationCodes = new HashMap<>();

    /**
     * ê³„ì¢Œ ìƒì„±
     * @param name ì´ë¦„
     * @param birth ìƒë…„ì›”ì¼
     * @param email ì´ë©”ì¼
     * @param password ê³„ì¢Œ ë¹„ë°€ë²ˆí˜¸
     * @param emailCode ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸
     * @return ìƒì„± ê²°ê³¼ ë©”ì‹œì§€
     */
    public String createAccount(String name, String birth, String email, int password, String emailCode) {
        try {
            // 1. ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ í™•ì¸
            if (!verifyEmailCode(email, emailCode)) {
                return "ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            }

            // 2. ì´ë¯¸ ê³„ì¢Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (accountMapper.existsByEmail(email)) {
                return "ì´ë¯¸ ê³„ì¢Œê°€ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.";
            }

            // 3. ì‚¬ìš©ì ì •ë³´ í™•ì¸/ìƒì„± (UserMapper í•„ìš”)
            UserVO user = userMapper.findByEmail(email);
            if (user == null) {
                // ìƒˆ ì‚¬ìš©ì ìƒì„±
                user = new UserVO();
                user.setUserEmail(email);
                user.setName(name);
                user.setActive(true);
                user.setRole("USER");
                userMapper.createUser(user);
            }

            // 4. ê³„ì¢Œ ìƒì„±
            AccountVO account = new AccountVO();
            account.setUserEmail(email);
            account.setAccountName(name + "ì˜ ê³„ì¢Œ");
            account.setBalance(0); // ì´ˆê¸° ì”ì•¡ 0ì›
            account.setAccountPassword(password);

            int result = accountMapper.createAccount(account);
            
            if (result > 0) {
                // ì¸ì¦ë²ˆí˜¸ ì‚­ì œ (ì‚¬ìš© ì™„ë£Œ)
                emailVerificationCodes.remove(email);
                return "ê³„ì¢Œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.";
            } else {
                return "ê³„ì¢Œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            }

        } catch (Exception e) {
            e.printStackTrace();
            return "ê³„ì¢Œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage();
        }
    }

    /**
     * ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ë°œì†¡
     * @param email ì´ë©”ì¼ ì£¼ì†Œ
     * @return ë°œì†¡ ê²°ê³¼ ë©”ì‹œì§€
     */
    public String sendEmailVerification(String email) {
        try {
            // 6ìë¦¬ ëœë¤ ì¸ì¦ë²ˆí˜¸ ìƒì„±
            String code = generateVerificationCode();
            
            // ì¸ì¦ë²ˆí˜¸ ì €ì¥ (ì‹¤ì œë¡œëŠ” ë§Œë£Œì‹œê°„ë„ ì„¤ì •í•´ì•¼ í•¨)
            emailVerificationCodes.put(email, code);
            
            // ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡
            emailService.sendVerificationEmail(email, code, null);
            
            System.out.println("ğŸ“§ ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ë°œì†¡ ì™„ë£Œ: " + email + " (ì¸ì¦ë²ˆí˜¸: " + code + ")");
            
            return "ì¸ì¦ë²ˆí˜¸ê°€ ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
        } catch (Exception e) {
            e.printStackTrace();
            return "ì¸ì¦ë²ˆí˜¸ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + e.getMessage();
        }
    }

    /**
     * ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ í™•ì¸
     * @param email ì´ë©”ì¼
     * @param inputCode ì…ë ¥ëœ ì¸ì¦ë²ˆí˜¸
     * @return ì¸ì¦ ì„±ê³µ ì—¬ë¶€
     */
    public boolean verifyEmailCode(String email, String inputCode) {
        String storedCode = emailVerificationCodes.get(email);
        return storedCode != null && storedCode.equals(inputCode);
    }

    /**
     * 6ìë¦¬ ëœë¤ ì¸ì¦ë²ˆí˜¸ ìƒì„±
     * @return ì¸ì¦ë²ˆí˜¸
     */
    private String generateVerificationCode() {
        Random random = new Random();
        int code = 100000 + random.nextInt(900000); // 100000~999999
        return String.valueOf(code);
    }

    /**
     * ì´ë©”ì¼ë¡œ ê³„ì¢Œ ì¡°íšŒ
     * @param email ì´ë©”ì¼
     * @return ê³„ì¢Œ ì •ë³´
     */
    public AccountVO getAccountByEmail(String email) {
        return accountMapper.findAccountByEmail(email);
    }

    /**
     * ê³„ì¢Œ IDë¡œ ê³„ì¢Œ ì¡°íšŒ
     * @param accountId ê³„ì¢Œ ID
     * @return ê³„ì¢Œ ì •ë³´
     */
    public AccountVO getAccountById(int accountId) {
        return accountMapper.findAccountById(accountId);
    }

    /**
     * ê³„ì¢Œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
     * @param accountId ê³„ì¢Œ ID
     * @param password ë¹„ë°€ë²ˆí˜¸
     * @return í™•ì¸ ê²°ê³¼
     */
    public boolean verifyAccountPassword(int accountId, int password) {
        return accountMapper.verifyPassword(accountId, password);
    }

    /**
     * ê³„ì¢Œ ì”ì•¡ ì—…ë°ì´íŠ¸
     * @param accountId ê³„ì¢Œ ID
     * @param newBalance ìƒˆë¡œìš´ ì”ì•¡
     * @return ì—…ë°ì´íŠ¸ ì„±ê³µ ì—¬ë¶€
     */
    public boolean updateBalance(int accountId, int newBalance) {
        int result = accountMapper.updateBalance(accountId, newBalance);
        return result > 0;
    }

    /**
     * ëª¨ë“  ê³„ì¢Œ ì¡°íšŒ (ê´€ë¦¬ììš©)
     * @return ëª¨ë“  ê³„ì¢Œ ëª©ë¡
     */
    public List<AccountVO> getAllAccounts() {
        return accountMapper.findAllAccounts();
    }

    /**
     * ê³„ì¢Œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
     * @param email ì´ë©”ì¼
     * @return ì¡´ì¬ ì—¬ë¶€
     */
    public boolean isAccountExists(String email) {
        return accountMapper.existsByEmail(email);
    }
}