package oww.banking.service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Random;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import lombok.extern.slf4j.Slf4j;
import oww.banking.mapper.AccountMapper;
import oww.banking.mapper.UserMapper;
import oww.banking.util.BankingJwtUtil;
import oww.banking.vo.AccountVO;
import oww.banking.vo.UserVO;

@Slf4j
@Service
@Transactional
public class SafeboxService {

    @Autowired
    private AccountMapper accountMapper;

    @Autowired
    private UserMapper userMapper;

    @Autowired
    private EmailService emailService;

    // ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ì €ì¥ìš© (ì‹¤ì œë¡œëŠ” Redisë‚˜ DBì— ì €ì¥í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ)
    private Map<String, String> emailVerificationCodes = new HashMap<>();

    @Autowired
    private BankingJwtUtil jwtUtil; // JWT ìœ í‹¸

    public Map<String, Object> login(String email, String password) {
        Map<String, Object> result = new HashMap<>();
        try {
            UserVO user = userMapper.findByEmail(email);
            // ìˆ˜ì •ëœ ë¶€ë¶„: AccountVOë¥¼ ë”°ë¡œ ê°€ì ¸ì™€ì„œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            AccountVO account = accountMapper.findAccountByEmail(email);

            if (user != null && account != null && account.getAccountPassword().equals(password)) {
                String token = jwtUtil.generateToken((long)user.getUserNo(), user.getName(), user.getRole());
                result.put("success", true);
                result.put("message", "ë¡œê·¸ì¸ ì„±ê³µ");
                result.put("token", token);
            } else {
                result.put("success", false);
                result.put("message", "ë¡œê·¸ì¸ ì‹¤íŒ¨: ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        } catch (Exception e) {
            e.printStackTrace();
            result.put("success", false);
            result.put("message", "ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
        }
        return result;
    }

    /**
     * ê³„ì¢Œ ìƒì„± (1ê³„ì • 1ê³„ì¢Œ ì œí•œ í¬í•¨)
     * @param name ì´ë¦„
     * @param email ì´ë©”ì¼
     * @param password ê³„ì¢Œ ë¹„ë°€ë²ˆí˜¸
     * @param emailCode ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸
     * @return ìƒì„± ê²°ê³¼ ë©”ì‹œì§€
     */
    public String createAccount(String name, String email, String password, String emailCode) {
        try {
            log.info("ğŸ¦ ê³„ì¢Œ ìƒì„± ì‹œì‘: {}", email);
            
            // 1. ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ í™•ì¸
            if (!verifyEmailCode(email, emailCode)) {
                log.warn("âŒ ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ë¶ˆì¼ì¹˜: {}", email);
                return "ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            }

            // 2. ì´ë©”ì¼ë¡œ ì´ë¯¸ ê³„ì¢Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (accountMapper.existsByEmail(email)) {
                log.warn("âŒ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê³„ì¢Œ (ì´ë©”ì¼): {}", email);
                return "ì´ë¯¸ ê³„ì¢Œê°€ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.";
            }

            // 3. ì‚¬ìš©ì ì •ë³´ í™•ì¸/ìƒì„±
            UserVO user = userMapper.findByEmail(email);
            if (user == null) {
                log.info("ğŸ“ ìƒˆ ì‚¬ìš©ì ìƒì„±: {}", email);
                user = new UserVO();
                user.setUserEmail(email);
                user.setName(name);
                user.setActive(true);
                user.setRole("USER");
                user.setProvider("LOCAL"); // ê¸°ë³¸ ì œê³µì
                userMapper.createUser(user);
                
                // ìƒì„±ëœ ì‚¬ìš©ì ì •ë³´ ë‹¤ì‹œ ì¡°íšŒ (userNo ê°€ì ¸ì˜¤ê¸° ìœ„í•´)
                user = userMapper.findByEmail(email);
                if (user == null) {
                    log.error("âŒ ì‚¬ìš©ì ìƒì„± í›„ ì¡°íšŒ ì‹¤íŒ¨: {}", email);
                    return "ì‚¬ìš©ì ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                }
            }

            // 4. âœ¨ 1ê³„ì • 1ê³„ì¢Œ ì œí•œ - ì´ë©”ì¼ë¡œ ê³„ì¢Œ ì¡´ì¬ ì—¬ë¶€ ì¬í™•ì¸ (ì´ë¯¸ ìœ„ì—ì„œ ì²´í¬í–ˆì§€ë§Œ ì•ˆì „ì¥ì¹˜)
            // ì´ë¯¸ ìœ„ì—ì„œ existsByEmailë¡œ ì²´í¬í–ˆìœ¼ë¯€ë¡œ ì´ ë¶€ë¶„ì€ ì¶”ê°€ ì•ˆì „ì¥ì¹˜ì…ë‹ˆë‹¤.

            // 5. ì‹¤ì œ ì€í–‰ ìŠ¤íƒ€ì¼ ê³„ì¢Œë²ˆí˜¸ ìƒì„±
            String accountNumber = generateBankStyleAccountNumber();
            log.info("ğŸ”¢ ìƒì„±ëœ ê³„ì¢Œë²ˆí˜¸: {}", accountNumber);

            // 6. ê³„ì¢Œ ê°ì²´ ìƒì„±
            AccountVO account = new AccountVO();
            account.setUserEmail(email); // ì´ë©”ì¼ ì„¤ì •
            account.setAccountNumber(accountNumber);
            account.setBalance(0); // ì´ˆê¸° ì”ì•¡ 0ì›
            account.setAccountPassword(password);

            // 7. ê³„ì¢Œ ìƒì„±
            int result = accountMapper.createAccount(account);
            
            if (result > 0) {
                // ì¸ì¦ë²ˆí˜¸ ì‚­ì œ (ì‚¬ìš© ì™„ë£Œ)
                emailVerificationCodes.remove(email);
                log.info("âœ… ê³„ì¢Œ ìƒì„± ì„±ê³µ: {}", accountNumber);
                return "ê³„ì¢Œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.";
            } else {
                log.error("âŒ DB ì €ì¥ ì‹¤íŒ¨");
                return "ê³„ì¢Œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            }

        } catch (Exception e) {
            log.error("âŒ ê³„ì¢Œ ìƒì„± ì¤‘ ì˜¤ë¥˜: {}", e.getMessage(), e);
            return "ê³„ì¢Œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage();
        }
    }

    /**
     * ì‹¤ì œ ì€í–‰ ìŠ¤íƒ€ì¼ ê³„ì¢Œë²ˆí˜¸ ìƒì„±
     * í˜•ì‹: 110-000000-XXX (110=ì€í–‰ì½”ë“œ, 000000=ë³¸ì ì½”ë“œ, XXX=ì¼ë ¨ë²ˆí˜¸)
     */
    private String generateBankStyleAccountNumber() {
        // ë‹¤ìŒ ì‹œí€€ìŠ¤ ê°’ ê°€ì ¸ì˜¤ê¸°
        int sequenceValue = accountMapper.getNextAccountSequence();
        
        // ì€í–‰ ìŠ¤íƒ€ì¼ ê³„ì¢Œë²ˆí˜¸ ìƒì„±
        String bankCode = "110";        // Own Wedding Wallet Bank ì½”ë“œ
        String branchCode = "000000";   // ë³¸ì  ì½”ë“œ
        String serialNumber = String.format("%03d", sequenceValue); // 3ìë¦¬ ì¼ë ¨ë²ˆí˜¸
        
        return bankCode + "-" + branchCode + "-" + serialNumber;
    }

    /**
     * ê³„ì¢Œë²ˆí˜¸ ì¤‘ë³µ í™•ì¸ (ì•ˆì „ì¥ì¹˜)
     */
    private boolean isAccountNumberExists(String accountNumber) {
        return accountMapper.existsByAccountNumber(accountNumber);
    }

    /**
     * ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ë°œì†¡ - ê°œì„ ëœ ë²„ì „
     * @param email ì´ë©”ì¼ ì£¼ì†Œ
     * @return ë°œì†¡ ê²°ê³¼ ë©”ì‹œì§€
     */
    public String sendEmailVerification(String email) {
        try {
            log.info("ğŸ“§ ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ë°œì†¡ ì‹œì‘: {}", email);
            
            // 1. ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬
            if (email == null || email.trim().isEmpty() || !email.contains("@")) {
                log.warn("âŒ ì˜ëª»ëœ ì´ë©”ì¼ í˜•ì‹: {}", email);
                throw new IllegalArgumentException("ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.");
            }
            
            // 2. 6ìë¦¬ ëœë¤ ì¸ì¦ë²ˆí˜¸ ìƒì„±
            String code = generateVerificationCode();
            log.info("âœ… ì¸ì¦ë²ˆí˜¸ ìƒì„± ì™„ë£Œ: {}", code);
            
            // 3. ì¸ì¦ë²ˆí˜¸ ì €ì¥
            emailVerificationCodes.put(email, code);
            log.info("âœ… ì¸ì¦ë²ˆí˜¸ ì €ì¥ ì™„ë£Œ");
            
            // 4. EmailServiceê°€ nullì¸ì§€ í™•ì¸
            if (emailService == null) {
                log.error("âŒ EmailServiceê°€ ì£¼ì…ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");
                throw new RuntimeException("EmailServiceê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }
            
            // 5. ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡
            log.info("ğŸ“§ EmailService.sendVerificationEmail í˜¸ì¶œ ì¤‘...");
            emailService.sendVerificationEmail(email, code, null);
            log.info("âœ… ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ!");
            
            return "ì¸ì¦ë²ˆí˜¸ê°€ ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
            
        } catch (IllegalArgumentException e) {
            log.warn("âŒ ì…ë ¥ê°’ ì˜¤ë¥˜: {}", e.getMessage());
            throw e;
        } catch (Exception e) {
            log.error("âŒ ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: {} - {}", e.getClass().getSimpleName(), e.getMessage(), e);
            
            // êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê³µ
            if (e.getMessage() != null) {
                if (e.getMessage().contains("Authentication failed")) {
                    return "ì´ë©”ì¼ ì¸ì¦ ì„¤ì •ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.";
                } else if (e.getMessage().contains("Mail server connection failed")) {
                    return "ë©”ì¼ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                }
            }
            
            return "ì¸ì¦ë²ˆí˜¸ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        }
    }

    /**
     * ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ í™•ì¸
     * @param email ì´ë©”ì¼
     * @param inputCode ì…ë ¥ëœ ì¸ì¦ë²ˆí˜¸
     * @return ì¸ì¦ ì„±ê³µ ì—¬ë¶€
     */
    public boolean verifyEmailCode(String email, String inputCode) {
        String storedCode = emailVerificationCodes.get(email);
        boolean isValid = storedCode != null && storedCode.equals(inputCode);
        log.info("ğŸ” ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ í™•ì¸: {} - {}", email, isValid ? "ì„±ê³µ" : "ì‹¤íŒ¨");
        return isValid;
    }

    /**
     * 6ìë¦¬ ëœë¤ ì¸ì¦ë²ˆí˜¸ ìƒì„±
     * @return ì¸ì¦ë²ˆí˜¸
     */
    private String generateVerificationCode() {
        Random random = new Random();
        int code = 100000 + random.nextInt(900000); // 100000~999999
        return String.valueOf(code);
    }

    /**
     * ì´ë©”ì¼ë¡œ ê³„ì¢Œ ì¡°íšŒ
     * @param email ì´ë©”ì¼
     * @return ê³„ì¢Œ ì •ë³´
     */
    public AccountVO getAccountByEmail(String email) {
        return accountMapper.findAccountByEmail(email);
    }

    /**
     * ê³„ì¢Œ IDë¡œ ê³„ì¢Œ ì¡°íšŒ
     * @param accountId ê³„ì¢Œ ID
     * @return ê³„ì¢Œ ì •ë³´
     */
    public AccountVO getAccountById(int accountId) {
        return accountMapper.findAccountById(accountId);
    }

    /**
     * ì‚¬ìš©ì ì´ë©”ì¼ë¡œ ê³„ì¢Œ ì¡°íšŒ (1ê³„ì • 1ê³„ì¢Œìš©)
     * @param email ì‚¬ìš©ì ì´ë©”ì¼
     * @return ê³„ì¢Œ ì •ë³´
     */
    public AccountVO getAccountByUserEmail(String email) {
        return accountMapper.findAccountByEmail(email);
    }

    /**
     * ê³„ì¢Œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
     * @param accountId ê³„ì¢Œ ID
     * @param password ë¹„ë°€ë²ˆí˜¸
     * @return í™•ì¸ ê²°ê³¼
     */
    public boolean verifyAccountPassword(int accountId, String password) {
        return accountMapper.verifyPassword(accountId, password);
    }

    /**
     * ê³„ì¢Œ ì”ì•¡ ì—…ë°ì´íŠ¸
     * @param accountId ê³„ì¢Œ ID
     * @param newBalance ìƒˆë¡œìš´ ì”ì•¡
     * @return ì—…ë°ì´íŠ¸ ì„±ê³µ ì—¬ë¶€
     */
    public boolean updateBalance(int accountId, int newBalance) {
        int result = accountMapper.updateBalance(accountId, newBalance);
        return result > 0;
    }

    /**
     * ëª¨ë“  ê³„ì¢Œ ì¡°íšŒ (ê´€ë¦¬ììš©)
     * @return ëª¨ë“  ê³„ì¢Œ ëª©ë¡
     */
    public List<AccountVO> getAllAccounts() {
        return accountMapper.findAllAccounts();
    }

    /**
     * ê³„ì¢Œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ì´ë©”ì¼ë¡œ)
     * @param email ì´ë©”ì¼
     * @return ì¡´ì¬ ì—¬ë¶€
     */
    public boolean isAccountExists(String email) {
        return accountMapper.existsByEmail(email);
    }

    /**
     * ê³„ì¢Œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ì´ë©”ì¼ë¡œ) - 1ê³„ì • 1ê³„ì¢Œ ì œí•œìš©
     * @param email ì‚¬ìš©ì ì´ë©”ì¼
     * @return ì¡´ì¬ ì—¬ë¶€
     */
    public boolean isAccountExistsByEmail(String email) {
        return accountMapper.existsByEmail(email);
    }
    
    public AccountVO findAccountByUserNo(int userNo) {
        return accountMapper.findAccountByUserNo(userNo);
    }
    
}