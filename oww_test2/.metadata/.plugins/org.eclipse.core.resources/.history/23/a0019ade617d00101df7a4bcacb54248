package com.oww.gateway.filter;

import com.oww.gateway.util.JwtUtil;
import org.springframework.cloud.gateway.filter.GatewayFilter;
import org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

/**
 * JWT í† í°ì„ ê²€ì¦í•˜ê³  ìš”ì²­ í—¤ë”ì— ì‚¬ìš©ì ì •ë³´ë¥¼ ì¶”ê°€í•˜ëŠ” ê²Œì´íŠ¸ì›¨ì´ í•„í„°ì…ë‹ˆë‹¤.
 * @Component ì• ë…¸í…Œì´ì…˜ì„ í†µí•´ Spring Beanìœ¼ë¡œ ìë™ ë“±ë¡ë©ë‹ˆë‹¤.
 */
@Component
public class JwtAuthenticationGatewayFilterFactory extends AbstractGatewayFilterFactory<JwtAuthenticationGatewayFilterFactory.Config> {

    private final JwtUtil jwtUtil;

    public JwtAuthenticationGatewayFilterFactory(JwtUtil jwtUtil) {
        super(Config.class);
        this.jwtUtil = jwtUtil;
    }

    @Override
    public GatewayFilter apply(Config config) {
        return (exchange, chain) -> {
            System.out.println("ğŸ” [JWT Filter] ì¸ì¦ í•„í„° ì‹œì‘");
            
            ServerHttpRequest request = exchange.getRequest();
            String requestPath = request.getPath().toString();
            System.out.println("ğŸ” [JWT Filter] ìš”ì²­ ê²½ë¡œ: " + requestPath);

            // JWT í† í° ì¶”ì¶œ (ì¿ í‚¤ ìš°ì„ , í—¤ë” ëŒ€ì•ˆ)
            String jwtToken = extractJwtToken(request);
            
            if (jwtToken == null) {
                System.out.println("âŒ [JWT Filter] JWT í† í°ì´ ì—†ìŒ - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸");
                return redirectToLogin(exchange);
            }

            try {
                // JWT í† í° ê²€ì¦
                if (!jwtUtil.validateToken(jwtToken)) {
                    System.out.println("âŒ [JWT Filter] JWT í† í° ê²€ì¦ ì‹¤íŒ¨ - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸");
                    return redirectToLogin(exchange);
                }

                // ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
                String username = jwtUtil.getUsernameFromToken(jwtToken);
                String role = jwtUtil.extractRole(jwtToken);
                String userNo = jwtUtil.extractUserNo(jwtToken);

                System.out.println("âœ… [JWT Filter] JWT í† í° ê²€ì¦ ì„±ê³µ");
                System.out.println("   - Username: " + username);
                System.out.println("   - Role: " + role);
                System.out.println("   - UserNo: " + userNo);

                // ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬í•  í—¤ë” ì¶”ê°€
                ServerWebExchange mutatedExchange = exchange.mutate()
                        .request(r -> r.header("Authorization", "Bearer " + jwtToken)
                                .header("X-User-No", userNo != null ? userNo : "")
                                .header("X-Username", username != null ? username : "")
                                .header("X-User-Role", role != null ? role : "USER"))
                        .build();

                System.out.println("âœ… [JWT Filter] í—¤ë” ì¶”ê°€ ì™„ë£Œ - ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì„œë¹„ìŠ¤ë¡œ ìš”ì²­ ì „ë‹¬");
                System.out.println("   - ëŒ€ìƒ ì„œë¹„ìŠ¤: " + request.getURI());

                return chain.filter(mutatedExchange);

            } catch (Exception e) {
                System.err.println("âŒ [JWT Filter] JWT í† í° ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ: " + e.getMessage());
                e.printStackTrace();
                return redirectToLogin(exchange);
            }
        };
    }

    /**
     * JWT í† í° ì¶”ì¶œ (ì¿ í‚¤ ìš°ì„ , Authorization í—¤ë” ëŒ€ì•ˆ)
     */
    private String extractJwtToken(ServerHttpRequest request) {
        // 1. ì¿ í‚¤ì—ì„œ jwt-token í™•ì¸
        String cookieToken = request.getCookies()
                .getFirst("jwt-token") != null ?
                request.getCookies()
                        .getFirst("jwt-token")
                        .getValue() : null;

        if (cookieToken != null) {
            System.out.println("âœ… [JWT Filter] ì¿ í‚¤ì—ì„œ JWT í† í° ë°œê²¬");
            return cookieToken;
        }

        // 2. Authorization í—¤ë”ì—ì„œ í™•ì¸
        String authHeader = request.getHeaders().getFirst(HttpHeaders.AUTHORIZATION);
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            System.out.println("âœ… [JWT Filter] Authorization í—¤ë”ì—ì„œ JWT í† í° ë°œê²¬");
            return authHeader.substring(7);
        }

        System.out.println("âŒ [JWT Filter] JWT í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ (ì¿ í‚¤, í—¤ë” ëª¨ë‘ ì—†ìŒ)");
        return null;
    }

    /**
     * ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
     */
    private Mono<Void> redirectToLogin(ServerWebExchange exchange) {
        System.out.println("ğŸ”„ [JWT Filter] ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸: /auth/login");
        
        exchange.getResponse().setStatusCode(HttpStatus.FOUND);
        exchange.getResponse().getHeaders().add("Location", "/auth/login");
        return exchange.getResponse().setComplete();
    }

    /**
     * JSON ì—ëŸ¬ ì‘ë‹µ (API ìš”ì²­ìš© - í•„ìš”ì‹œ ì‚¬ìš©)
     */
    private Mono<Void> createErrorResponse(ServerWebExchange exchange, String errorMessage, HttpStatus status) {
        System.out.println("âŒ [JWT Filter] JSON ì—ëŸ¬ ì‘ë‹µ: " + errorMessage);
        
        exchange.getResponse().setStatusCode(status);
        exchange.getResponse().getHeaders().add("Content-Type", "application/json");

        String body = String.format("{\"error\": \"%s\", \"message\": \"%s\", \"timestamp\": \"%s\"}",
                status.getReasonPhrase(), errorMessage, java.time.Instant.now());

        return exchange.getResponse().writeWith(
                Mono.just(exchange.getResponse().bufferFactory().wrap(body.getBytes()))
        );
    }

    public static class Config {
        // í•„ìš”ì‹œ ì„¤ì • ê°’ë“¤ ì¶”ê°€ ê°€ëŠ¥
        private boolean redirectOnFailure = true;
        
        public boolean isRedirectOnFailure() {
            return redirectOnFailure;
        }
        
        public void setRedirectOnFailure(boolean redirectOnFailure) {
            this.redirectOnFailure = redirectOnFailure;
        }
    }
    
    @Component
    public class JwtCookieToHeaderFilter implements GlobalFilter, Ordered {

        @Override
        public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
            ServerHttpRequest request = exchange.getRequest();
            
            // Authorization í—¤ë”ê°€ ì´ë¯¸ ìˆìœ¼ë©´ skip
            if (request.getHeaders().containsKey("Authorization")) {
                return chain.filter(exchange);
            }
            
            // ì¿ í‚¤ì—ì„œ jwt-token ì°¾ê¸°
            String jwtToken = request.getCookies().getFirst("jwt-token")
                    ?.getValue();
            
            if (jwtToken != null && !jwtToken.isEmpty()) {
                // Authorization í—¤ë” ì¶”ê°€
                ServerHttpRequest modifiedRequest = request.mutate()
                        .header("Authorization", "Bearer " + jwtToken)
                        .build();
                
                return chain.filter(exchange.mutate().request(modifiedRequest).build());
            }
            
            return chain.filter(exchange);
        }

        @Override
        public int getOrder() {
            return -1; // ë‹¤ë¥¸ í•„í„°ë³´ë‹¤ ë¨¼ì € ì‹¤í–‰
        }
    }
}