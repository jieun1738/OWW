<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì„¸ì´í”„ë°•ìŠ¤ ì…ì¶œê¸ˆ ë° ì •ê¸°ì €ê¸ˆí†µ</title>
  <link rel="stylesheet" th:href="@{/css/safebox_css.css}" />
  <style>
    .balance-info {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      font-weight: bold;
    }
    
    .balance-info.total {
      background: #e3f2fd;
      border: 2px solid #2196f3;
    }
    
    .balance-amount {
      color: #27ae60;
      font-size: 1.1em;
    }
    
    .safebox-amount {
      color: #8e44ad;
      font-size: 1.1em;
    }
    
    .total-amount {
      color: #2196f3;
      font-size: 1.2em;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin: 10px 0;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }

    .error-message {
      color: #e74c3c;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .success-message {
      color: #27ae60;
      font-size: 0.9em;
      margin-top: 5px;
    }
  </style>
</head>
<body>

  <!-- ì‚¬ìš©ì ì •ë³´ ë° ì”ì•¡ í‘œì‹œ -->
  <div class="card">
    <div class="section-title">
      <span th:text="${userName}">ì‚¬ìš©ì</span>ë‹˜ì˜ ìì‚° í˜„í™©
    </div>

    <div class="balance-info">
      <div>ê³„ì¢Œ ì”ì•¡</div>
      <div class="balance-amount" id="accountBalance" 
           th:text="'â‚©' + ${#numbers.formatInteger(accountBalance ?: 0, 3, 'COMMA')}">â‚©0</div>
    </div>
    
    <div class="balance-info">
      <div>ì„¸ì´í”„ë°•ìŠ¤</div>
      <div class="safebox-amount" id="safeboxBalance" 
           th:text="'â‚©' + ${#numbers.formatInteger(safeboxBalance ?: 0, 3, 'COMMA')}">â‚©0</div>
    </div>
    
    <div class="balance-info total">
      <div>ì´ ìì‚°</div>
      <div class="total-amount" id="totalAssets" 
           th:text="'â‚©' + ${#numbers.formatInteger(totalAssets ?: 0, 3, 'COMMA')}">â‚©0</div>
    </div>
  </div>

  <!-- ì„¸ì´í”„ë°•ìŠ¤ ì…ì¶œê¸ˆ ì¹´ë“œ -->
  <div class="card">
    <div class="section-title">ğŸ’° ì„¸ì´í”„ë°•ìŠ¤ ì…ì¶œê¸ˆ</div>

    <div class="slider-container">
      <div class="slider-label" id="currentAmount">â‚©0</div>
      <input type="range" id="slider" min="0" max="0" step="10000" value="0" />
      <div class="step-buttons">
        <button onclick="adjust(-10000)">-1ë§Œ</button>
        <button onclick="adjust(10000)">+1ë§Œ</button>
      </div>
    </div>

    <div style="display: flex; gap: 10px; margin: 20px 0;">
      <button class="submit-btn" style="flex: 1; background: #27ae60;" onclick="transferMoney('deposit')">
        ê³„ì¢Œ â†’ ì„¸ì´í”„ë°•ìŠ¤ ì…ê¸ˆ
      </button>
      <button class="submit-btn" style="flex: 1; background: #e74c3c;" onclick="transferMoney('withdraw')">
        ì„¸ì´í”„ë°•ìŠ¤ â†’ ê³„ì¢Œ ì¶œê¸ˆ
      </button>
    </div>

    <div id="transferMessage"></div>

    <div class="note">
      ì„¸ì´í”„ë°•ìŠ¤ í•´ì œ ì˜ˆì •ì¼: 2025.08.10<br/>
      ì¶œê¸ˆì€ í•´ì œì¼ ì´í›„ì— ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </div>
  </div>

  <!-- ì •ê¸°ì €ê¸ˆí†µ ì¹´ë“œ -->
  <div class="card">
    <div class="section-title">ğŸ¯ ì •ê¸°ì €ê¸ˆí†µ ì„¤ì •</div>

    <form id="autoSaveForm">
      <div class="form-group">
        <label>ëª©í‘œ ê¸ˆì•¡</label>
        <input type="number" id="goalAmount" placeholder="ì˜ˆ: 500000" required />
      </div>

      <div class="form-group">
        <label>ì‹œì‘ì¼</label>
        <input type="date" id="startDate" required />
      </div>

      <div class="form-group">
        <label>ì¢…ë£Œì¼ (ëª©í‘œ ë‹¬ì„±ì¼)</label>
        <input type="date" id="endDate" required />
      </div>

      <div class="form-group">
        <label>ìë™ ì €ì¶• ì£¼ê¸°</label>
        <div class="radio-group">
          <label><input type="radio" name="cycle" value="daily" checked /> ë§¤ì¼</label>
          <label><input type="radio" name="cycle" value="monthly" /> ë§¤ì›”</label>
        </div>
      </div>

      <div class="form-group">
        <label>ìë™ ì €ì¶• ê¸ˆì•¡</label>
        <input type="number" id="autoAmount" placeholder="ìë™ ê³„ì‚°ë¨" readonly />
      </div>

      <button class="submit-btn" type="submit">ì •ê¸°ì €ê¸ˆí†µ ì„¤ì •í•˜ê¸°</button>
      <div id="goalMessage"></div>
    </form>
  </div>

  <script src="/js/auth-buttons.js"></script>

  <script>
    // ì´ˆê¸° ë°ì´í„° ì„¤ì •
    let accountBalance = /*[[${accountBalance ?: 0}]]*/ 0;
    let safeboxBalance = /*[[${safeboxBalance ?: 0}]]*/ 0;
    let totalAssets = /*[[${totalAssets ?: 0}]]*/ 0;

    // DOM ìš”ì†Œ
    const slider = document.getElementById("slider");
    const currentAmount = document.getElementById("currentAmount");

    // ìŠ¬ë¼ì´ë” ì´ˆê¸° ì„¤ì •
    slider.max = totalAssets;
    slider.value = safeboxBalance;
    updateSliderDisplay();

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function formatCurrency(value) {
      return 'â‚©' + value.toLocaleString();
    }

    function updateSliderDisplay() {
      currentAmount.textContent = formatCurrency(Number(slider.value));
    }

    function updateBalanceDisplay() {
      document.getElementById("accountBalance").textContent = formatCurrency(accountBalance);
      document.getElementById("safeboxBalance").textContent = formatCurrency(safeboxBalance);
      document.getElementById("totalAssets").textContent = formatCurrency(totalAssets);
      
      // ìŠ¬ë¼ì´ë” ë²”ìœ„ ì—…ë°ì´íŠ¸
      slider.max = totalAssets;
      slider.value = safeboxBalance;
      updateSliderDisplay();
    }

    // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
    slider.addEventListener("input", updateSliderDisplay);

    function adjust(amount) {
      let newValue = Number(slider.value) + amount;
      newValue = Math.min(Math.max(newValue, 0), totalAssets);
      slider.value = newValue;
      updateSliderDisplay();
    }

    // ì„¸ì´í”„ë°•ìŠ¤ ì´ì²´ í•¨ìˆ˜
    function transferMoney(type) {
      const targetAmount = Number(slider.value);
      const currentSafebox = safeboxBalance;
      
      let transferAmount;
      if (type === 'deposit') {
        transferAmount = targetAmount - currentSafebox;
      } else {
        transferAmount = currentSafebox - targetAmount;
      }

      if (transferAmount <= 0) {
        showMessage('transferMessage', 'ì´ì²´í•  ê¸ˆì•¡ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      // ì„œë²„ì— ì´ì²´ ìš”ì²­
      fetch('/banking/safebox/transfer', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: `amount=${transferAmount}&type=${type}`,
        credentials: 'include'
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // ì”ì•¡ ì—…ë°ì´íŠ¸
          accountBalance = data.accountBalance;
          safeboxBalance = data.safeboxBalance;
          totalAssets = accountBalance + safeboxBalance;
          
          updateBalanceDisplay();
          showMessage('transferMessage', data.message, 'success');
        } else {
          showMessage('transferMessage', data.message, 'error');
        }
      })
      .catch(err => {
        console.error('ì´ì²´ ì˜¤ë¥˜:', err);
        showMessage('transferMessage', 'ì´ì²´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      });
    }

    // ì •ê¸°ì €ê¸ˆí†µ ë¡œì§
    const goalInput = document.getElementById("goalAmount");
    const startDate = document.getElementById("startDate");
    const endDate = document.getElementById("endDate");
    const autoAmount = document.getElementById("autoAmount");

    function calculateAutoSaveAmount() {
      const goal = Number(goalInput.value);
      const start = new Date(startDate.value);
      const end = new Date(endDate.value);
      const cycle = document.querySelector('input[name="cycle"]:checked').value;

      if (!goal || !startDate.value || !endDate.value || start >= end) {
        autoAmount.value = '';
        return;
      }

      const msPerDay = 24 * 60 * 60 * 1000;
      const diffDays = Math.ceil((end - start) / msPerDay);
      const diffMonths = Math.ceil(diffDays / 30);

      let periods = cycle === 'daily' ? diffDays : diffMonths;
      if (periods <= 0) {
        autoAmount.value = '';
        return;
      }

      const perAmount = Math.ceil(goal / periods);
      autoAmount.value = perAmount;
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    goalInput.addEventListener("input", calculateAutoSaveAmount);
    startDate.addEventListener("change", calculateAutoSaveAmount);
    endDate.addEventListener("change", calculateAutoSaveAmount);
    document.querySelectorAll('input[name="cycle"]').forEach(radio => {
      radio.addEventListener("change", calculateAutoSaveAmount);
    });

    // ì •ê¸°ì €ê¸ˆí†µ ì„¤ì • í¼ ì œì¶œ
    document.getElementById("autoSaveForm").addEventListener("submit", function (e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const params = new URLSearchParams();
      
      params.append('goalAmount', goalInput.value);
      params.append('startDate', startDate.value);
      params.append('endDate', endDate.value);
      params.append('cycle', document.querySelector('input[name="cycle"]:checked').value);
      params.append('autoAmount', autoAmount.value);

      fetch('/banking/safebox/goal', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: params.toString(),
        credentials: 'include'
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showMessage('goalMessage', data.message, 'success');
          this.reset();
          autoAmount.value = '';
        } else {
          showMessage('goalMessage', data.message, '