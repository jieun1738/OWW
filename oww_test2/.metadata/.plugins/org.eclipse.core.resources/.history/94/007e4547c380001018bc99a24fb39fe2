package oww.banking.controller;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;
import oww.banking.service.AccountService;
import oww.banking.service.SafeboxService;
import oww.banking.service.TransferService;
import oww.banking.vo.AccountVO;
import oww.banking.vo.SafeboxGoalVO;
import oww.banking.vo.SafeboxHistoryVO;
import oww.banking.vo.SafeboxVO;
import oww.banking.vo.TransferHistoryVO;

@Controller
@RequestMapping("/banking/safebox")
public class SafeboxController {

    @Autowired
    private SafeboxService safeboxService;
    
    @Autowired
    private AccountService accountService;
    
    @Autowired
    private TransferService transferService;

    /**
     * 세이프박스 기본 페이지 (리다이렉트)
     */
    @GetMapping("")
    public String safeboxIndex() {
        return "redirect:/banking/safebox/main";
    }

    /**
     * 세이프박스 메인 페이지
     */
    @GetMapping("/main")
    public String safeboxMain(HttpSession session, Model model, HttpServletRequest request) {
        // 실제 사용자 정보 가져오기
        String userEmail = request.getHeader("x-user-email");
        String userNo = request.getHeader("x-user-no");
 
        // 여전히 없으면 세션에서 가져오기
        if (userEmail == null) {
            userEmail = (String) session.getAttribute("userEmail");
        }


        try {
            // AccountService 사용
            AccountVO account = accountService.getAccountByEmail(userEmail);
            System.out.println("Account found: " + (account != null));
            
            // 세이프박스 정보 조회
            SafeboxVO safebox = safeboxService.getSafeboxByEmail(userEmail);
            System.out.println("Safebox found: " + (safebox != null));
            
            // 총 자산 계산
            BigDecimal totalAssets = safeboxService.getTotalAssets(userEmail);
            System.out.println("Total assets: " + totalAssets);
            
            // 정기저금 목표 리스트 조회
            List<SafeboxGoalVO> goals = safeboxService.getSavingGoals(userEmail);

            model.addAttribute("account", account);
            model.addAttribute("safebox", safebox);
            model.addAttribute("balance", account != null ? BigDecimal.valueOf(account.getBalance()) : BigDecimal.ZERO);
            model.addAttribute("safeboxBalance", safebox != null ? safebox.getBalance() : BigDecimal.ZERO);
            model.addAttribute("totalAssets", totalAssets);
            model.addAttribute("goals", goals);

            return "safebox/main";
        } catch (Exception e) {
            e.printStackTrace();
            model.addAttribute("error", "세이프박스 정보를 불러오는 중 오류가 발생했습니다: " + e.getMessage());
            return "error";
        }
    }

    /**
     * 세이프박스 금액 설정 (AJAX)
     */
    @PostMapping("/setAmount")
    @ResponseBody
    public Map<String, Object> setSafeboxAmount(@RequestParam("amount") BigDecimal amount, 
                                               HttpSession session, HttpServletRequest request) {
        Map<String, Object> result = new HashMap<>();
        
        // 실제 사용자 정보 가져오기
        String userEmail = request.getHeader("x-user-email");
        String userNo = request.getHeader("x-user-no");
        
        // x-user-email이 ???이거나 null이면 실제 이메일 사용
        if (userEmail == null || "???".equals(userEmail)) {
            userEmail = "dudtlr5119@gmail.com";
            System.out.println("SET_AMOUNT - Using actual logged-in email");
        }
        
        // 여전히 없으면 세션에서 가져오기
        if (userEmail == null) {
            userEmail = (String) session.getAttribute("userEmail");
        }

        try {
            boolean success = safeboxService.setSafeboxAmount(userEmail, amount);
            
            if (success) {
                result.put("success", true);
                result.put("message", "세이프박스 금액이 설정되었습니다.");
                
                // 업데이트된 잔액 정보 반환
                AccountVO account = accountService.getAccountByEmail(userEmail);
                SafeboxVO safebox = safeboxService.getSafeboxByEmail(userEmail);
                
                result.put("accountBalance", account != null ? account.getBalance() : 0);
                result.put("safeboxBalance", safebox != null ? safebox.getBalance() : 0);
            } else {
                result.put("success", false);
                result.put("message", "세이프박스 설정에 실패했습니다.");
            }
        } catch (Exception e) {
            e.printStackTrace();
            result.put("success", false);
            result.put("message", "오류가 발생했습니다: " + e.getMessage());
        }

        return result;
    }

    /**
     * 정기저금통 설정 (AJAX)
     */
    @PostMapping("/createGoal")
    @ResponseBody
    public Map<String, Object> createSavingGoal(@RequestParam("goalAmount") BigDecimal goalAmount,
                                               @RequestParam("startDate") String startDateStr,
                                               @RequestParam("endDate") String endDateStr,
                                               @RequestParam("cycle") String cycle,
                                               HttpSession session, HttpServletRequest request) {
        Map<String, Object> result = new HashMap<>();
        
        // 실제 사용자 정보 가져오기
        String userEmail = request.getHeader("x-user-email");
        String userNo = request.getHeader("x-user-no");
        
        // x-user-email이 ???이거나 null이면 실제 이메일 사용
        if (userEmail == null || "???".equals(userEmail)) {
            userEmail = "dudtlr5119@gmail.com";
        }
        
        // 여전히 없으면 세션에서 가져오기
        if (userEmail == null) {
            userEmail = (String) session.getAttribute("userEmail");
        }

        try {
            LocalDate startDate = LocalDate.parse(startDateStr);
            LocalDate endDate = LocalDate.parse(endDateStr);
            
            // 기본 제목 설정 (실제로는 프론트에서 받아올 수도 있음)
            String title = "정기저금 목표 - " + goalAmount + "원";
            
            boolean success = safeboxService.createSavingGoal(userEmail, title, goalAmount, 
                                                            startDate, endDate, cycle);
            
            if (success) {
                result.put("success", true);
                result.put("message", "정기저금통이 설정되었습니다.");
            } else {
                result.put("success", false);
                result.put("message", "정기저금통 설정에 실패했습니다.");
            }
        } catch (Exception e) {
            e.printStackTrace();
            result.put("success", false);
            result.put("message", "오류가 발생했습니다: " + e.getMessage());
        }

        return result;
    }

    /**
     * 저축 목표 상세 페이지
     */
    @GetMapping("/goal/{goalId}")
    public String goalDetail(@PathVariable("goalId") int goalId, Model model, HttpSession session) {
        String userEmail = (String) session.getAttribute("userEmail");
        if (userEmail == null) {
            return "redirect:/login";
        }

        try {
            // 저축 내역 조회
            List<SafeboxHistoryVO> history = safeboxService.getSavingHistory(goalId);
            
            // 총 저축 금액 조회
            BigDecimal totalSaved = safeboxService.getTotalSavedAmount(goalId);

            model.addAttribute("history", history);
            model.addAttribute("totalSaved", totalSaved);
            model.addAttribute("goalId", goalId);

            return "safebox/goal-detail";
        } catch (Exception e) {
            e.printStackTrace();
            model.addAttribute("error", "저축 목표 정보를 불러오는 중 오류가 발생했습니다.");
            return "error";
        }
    }


    /**
     * 세이프박스 거래내역 조회
     */
    @GetMapping("/history")
    public String safeboxHistory(Model model, HttpServletRequest request) {
        try {
            // 사용자 이메일 가져오기
            String userEmail = request.getHeader("x-user-email");
            if (userEmail == null) {
                // 세션에서 가져오기
                HttpSession session = request.getSession();
                userEmail = (String) session.getAttribute("userEmail");
            }

            // Safebox 내역 조회
            List<SafeboxHistoryVO> history = safeboxService.getHistoryByUserEmail(userEmail);

            model.addAttribute("history", history);

            // templates/safebox/history.html 렌더링
            return "safebox/history";

        } catch (Exception e) {
            e.printStackTrace();
            model.addAttribute("errorMessage", "세이프박스 내역 조회 중 오류가 발생했습니다.");
            return "error";
        }
    }



    /**
     * 세이프박스 정보 조회 (AJAX)
     */
    @GetMapping("/info")
    @ResponseBody
    public Map<String, Object> getSafeboxInfo(HttpSession session, HttpServletRequest request) {
        Map<String, Object> result = new HashMap<>();
        
        // 실제 사용자 정보 가져오기
        String userEmail = request.getHeader("x-user-email");
        String userNo = request.getHeader("x-user-no");
        
        // 디버깅용 로그
        System.out.println("INFO - User Email from header: " + userEmail);
        System.out.println("INFO - User No from header: " + userNo);
        
        // x-user-email이 ???이거나 null이면 실제 이메일 사용
        if (userEmail == null || "???".equals(userEmail)) {
            userEmail = "dudtlr5119@gmail.com";
            System.out.println("INFO - Using actual logged-in email");
        }
        
        // 여전히 없으면 세션에서 가져오기
        if (userEmail == null) {
            userEmail = (String) session.getAttribute("userEmail");
        }

        try {
            AccountVO account = accountService.getAccountByEmail(userEmail);
            SafeboxVO safebox = safeboxService.getSafeboxByEmail(userEmail);
            BigDecimal totalAssets = safeboxService.getTotalAssets(userEmail);

            result.put("success", true);
            result.put("accountBalance", account != null ? account.getBalance() : 0);
            result.put("safeboxBalance", safebox != null ? safebox.getBalance() : 0);
            result.put("totalAssets", totalAssets);
        } catch (Exception e) {
            e.printStackTrace();
            result.put("success", false);
            result.put("message", "세이프박스 정보를 불러오는 중 오류가 발생했습니다.");
        }

        return result;
    }
}