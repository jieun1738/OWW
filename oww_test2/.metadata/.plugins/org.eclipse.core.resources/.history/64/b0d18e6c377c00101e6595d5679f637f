@RestController
@RequestMapping("/test")
public class EmailTestController {

    @Autowired
    private EmailService emailService;
    
    @Autowired
    private JavaMailSender mailSender;
    
    @Value("${spring.mail.username}")
    private String mailUsername;
    
    @Value("${spring.mail.password}")
    private String mailPassword;
    
    @Value("${mail.from.email}")
    private String fromEmail;

    /**
     * ì´ë©”ì¼ ì„¤ì • í™•ì¸ìš© ì—”ë“œí¬ì¸íŠ¸
     */
    @GetMapping("/email-config")
    public ResponseEntity<Map<String, Object>> testEmailConfig() {
        Map<String, Object> response = new HashMap<>();
        
        try {
            System.out.println("ğŸ” ì´ë©”ì¼ ì„¤ì • í™•ì¸ ì‹œì‘...");
            
            // 1. ì„¤ì •ê°’ í™•ì¸
            response.put("mailUsername", mailUsername);
            response.put("mailPassword", mailPassword != null ? "****" : "NULL");
            response.put("fromEmail", fromEmail);
            response.put("mailSender", mailSender != null ? "ì£¼ì…ë¨" : "NULL");
            response.put("emailService", emailService != null ? "ì£¼ì…ë¨" : "NULL");
            
            // 2. JavaMailSender ì„¤ì • í™•ì¸
            if (mailSender instanceof org.springframework.mail.javamail.JavaMailSenderImpl) {
                org.springframework.mail.javamail.JavaMailSenderImpl sender = 
                    (org.springframework.mail.javamail.JavaMailSenderImpl) mailSender;
                
                response.put("host", sender.getHost());
                response.put("port", sender.getPort());
                response.put("username", sender.getUsername());
                response.put("properties", sender.getJavaMailProperties().toString());
            }
            
            System.out.println("âœ… ì´ë©”ì¼ ì„¤ì • í™•ì¸ ì™„ë£Œ");
            response.put("status", "success");
            
        } catch (Exception e) {
            System.out.println("âŒ ì´ë©”ì¼ ì„¤ì • í™•ì¸ ì‹¤íŒ¨: " + e.getMessage());
            e.printStackTrace();
            response.put("status", "error");
            response.put("error", e.getMessage());
        }
        
        return ResponseEntity.ok(response);
    }
    
    /**
     * ê°„ë‹¨í•œ ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
     */
    @PostMapping("/send-simple-email")
    public ResponseEntity<Map<String, Object>> testSimpleEmail(
            @RequestParam("to") String toEmail) {
        
        Map<String, Object> response = new HashMap<>();
        
        try {
            System.out.println("ğŸ“§ ê°„ë‹¨í•œ ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸ ì‹œì‘: " + toEmail);
            
            // ì§ì ‘ JavaMailSender ì‚¬ìš©í•´ì„œ í…ŒìŠ¤íŠ¸
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message, false, "UTF-8");
            
            helper.setFrom(fromEmail, "í…ŒìŠ¤íŠ¸ë°œì†¡ì");
            helper.setTo(toEmail);
            helper.setSubject("ì´ë©”ì¼ ì„¤ì • í…ŒìŠ¤íŠ¸");
            helper.setText("ì´ë©”ì¼ ì„¤ì •ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!", false);
            
            mailSender.send(message);
            
            System.out.println("âœ… ê°„ë‹¨í•œ ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ!");
            response.put("status", "success");
            response.put("message", "ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ");
            
        } catch (Exception e) {
            System.out.println("âŒ ê°„ë‹¨í•œ ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: " + e.getClass().getSimpleName());
            System.out.println("âŒ ì˜¤ë¥˜ ìƒì„¸: " + e.getMessage());
            e.printStackTrace();
            
            response.put("status", "error");
            response.put("error", e.getClass().getSimpleName());
            response.put("message", e.getMessage());
        }
        
        return ResponseEntity.ok(response);
    }
    
    /**
     * EmailServiceë¥¼ í†µí•œ ë°œì†¡ í…ŒìŠ¤íŠ¸
     */
    @PostMapping("/send-verification-test")
    public ResponseEntity<Map<String, Object>> testVerificationEmail(
            @RequestParam("to") String toEmail) {
        
        Map<String, Object> response = new HashMap<>();
        
        try {
            System.out.println("ğŸ“§ EmailService í†µí•œ ì¸ì¦ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸: " + toEmail);
            
            emailService.sendVerificationEmail(toEmail, "123456", "í…ŒìŠ¤íŠ¸ì‚¬ìš©ì");
            
            response.put("status", "success");
            response.put("message", "EmailService ë°œì†¡ ì„±ê³µ");
            
        } catch (Exception e) {
            System.out.println("âŒ EmailService ë°œì†¡ ì‹¤íŒ¨: " + e.getMessage());
            e.printStackTrace();
            
            response.put("status", "error");
            response.put("error", e.getClass().getSimpleName());
            response.put("message", e.getMessage());
        }
        
        return ResponseEntity.ok(response);
    }
}