package oww.banking.service;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import oww.banking.mapper.AccountMapper;
import oww.banking.mapper.SafeboxMapper;
import oww.banking.vo.AccountVO;
import oww.banking.vo.SafeboxGoalVO;
import oww.banking.vo.SafeboxHistoryVO;
import oww.banking.vo.SafeboxVO;

@Service
public class SafeboxService {

    @Autowired
    private SafeboxMapper safeboxMapper;
    
    @Autowired
    private AccountMapper accountMapper;

    /**
     * 세이프박스 금액 설정 (계좌에서 세이프박스로 이동)
     */
    @Transactional
    public boolean setSafeboxAmount(String userEmail, BigDecimal amount) {
        try {
            // 계좌 정보 조회
            AccountVO account = accountMapper.findAccountByEmail(userEmail);
            if (account == null) {
                throw new RuntimeException("계좌를 찾을 수 없습니다.");
            }

            // 세이프박스 존재 여부 확인
            SafeboxVO safebox = safeboxMapper.findSafeboxByEmail(userEmail);
            
            if (safebox == null) {
                // 세이프박스가 없으면 생성
                safebox = new SafeboxVO(userEmail, amount);
                safeboxMapper.createSafebox(safebox);
            } else {
                // 기존 세이프박스 금액 업데이트
                Map<String, Object> params = new HashMap<>();
                params.put("safeboxId", safebox.getSafeboxId());
                params.put("balance", amount);
                safeboxMapper.updateSafeboxBalance(params);
            }

            // 계좌 잔액 업데이트 (전체 잔액에서 세이프박스 금액을 뺀 만큼)
            BigDecimal totalBalance = account.getBalance().add(safebox != null ? safebox.getBalance() : BigDecimal.ZERO);
            BigDecimal newAccountBalance = totalBalance.subtract(amount);
            
            Map<String, Object> accountParams = new HashMap<>();
            accountParams.put("accountId", account.getAccountId());
            accountParams.put("balance", newAccountBalance);
            accountMapper.updateBalance(accountParams);

            return true;
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 정기저금통 설정
     */
    @Transactional
    public boolean createSavingGoal(String userEmail, String title, BigDecimal targetAmount, 
                                  LocalDate startDate, LocalDate endDate, String paymentType) {
        try {
            // 세이프박스 조회 (없으면 생성)
            SafeboxVO safebox = safeboxMapper.findSafeboxByEmail(userEmail);
            if (safebox == null) {
                safebox = new SafeboxVO(userEmail, BigDecimal.ZERO);
                safeboxMapper.createSafebox(safebox);
                safebox = safeboxMapper.findSafeboxByEmail(userEmail); // 생성된 세이프박스 다시 조회
            }

            // 정기저금 목표 생성
            SafeboxGoalVO goal = new SafeboxGoalVO(safebox.getSafeboxId(), title, targetAmount, 
                                                 startDate, endDate, paymentType);
            safeboxMapper.createSafeboxGoal(goal);

            return true;
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 사용자의 세이프박스 정보 조회
     */
    public SafeboxVO getSafeboxByEmail(String userEmail) {
        return safeboxMapper.findSafeboxByEmail(userEmail);
    }

    /**
     * 사용자의 정기저금 목표 리스트 조회
     */
    public List<SafeboxGoalVO> getSavingGoals(String userEmail) {
        SafeboxVO safebox = safeboxMapper.findSafeboxByEmail(userEmail);
        if (safebox == null) {
            return null;
        }
        return safeboxMapper.findGoalsBySafeboxId(safebox.getSafeboxId());
    }

    /**
     * 특정 목표의 저축 내역 조회
     */
    public List<SafeboxHistoryVO> getSavingHistory(int goalId) {
        return safeboxMapper.findHistoryByGoalId(goalId);
    }

    /**
     * 특정 목표의 총 저축 금액 조회
     */
    public BigDecimal getTotalSavedAmount(int goalId) {
        return safeboxMapper.getTotalSavedAmountByGoalId(goalId);
    }

    /**
     * 사용자의 모든 저축 내역 조회
     */
    public List<SafeboxHistoryVO> getAllSavingHistory(String userEmail) {
        return safeboxMapper.findHistoryByUserEmail(userEmail);
    }

    /**
     * 자동 저축 실행 (스케줄러에서 호출)
     */
    @Transactional
    public boolean executeAutoSaving(int goalId, BigDecimal amount) {
        try {
            // 목표 정보 조회
            SafeboxGoalVO goal = safeboxMapper.findGoalById(goalId);
            if (goal == null) {
                return false;
            }

            // 세이프박스 정보 조회
            SafeboxVO safebox = safeboxMapper.findSafeboxByEmail(getUserEmailBySafeboxId(goal.getSafeboxId()));
            if (safebox == null) {
                return false;
            }

            // 계좌에서 금액 차감 및 세이프박스에 추가
            AccountVO account = accountMapper.findAccountByEmail(safebox.getUserEmail());
            if (account == null || account.getBalance().compareTo(amount) < 0) {
                return false; // 잔액 부족
            }

            // 계좌 잔액 업데이트
            Map<String, Object> accountParams = new HashMap<>();
            accountParams.put("accountId", account.getAccountId());
            accountParams.put("balance", account.getBalance().subtract(amount));
            accountMapper.updateBalance(accountParams);

            // 세이프박스 잔액 업데이트
            Map<String, Object> safeboxParams = new HashMap<>();
            safeboxParams.put("safeboxId", safebox.getSafeboxId());
            safeboxParams.put("balance", safebox.getBalance().add(amount));
            safeboxMapper.updateSafeboxBalance(safeboxParams);

            // 저축 내역 기록
            SafeboxHistoryVO history = new SafeboxHistoryVO(goalId, amount, LocalDate.now());
            safeboxMapper.createSafeboxHistory(history);

            return true;
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 세이프박스 ID로 사용자 이메일 조회 (private 메서드)
     */
    private String getUserEmailBySafeboxId(int safeboxId) {
        // 이 메서드는 SafeboxMapper에 추가적인 쿼리가 필요할 수 있습니다.
        // 현재는 간단히 구현하였으나, 실제로는 별도의 쿼리 메서드가 필요합니다.
        return null; // 실제 구현에서는 적절한 쿼리 결과를 반환해야 합니다.
    }

    /**
     * 세이프박스 존재 여부 확인
     */
    public boolean hasSafebox(String userEmail) {
        return safeboxMapper.existsByEmail(userEmail);
    }

    /**
     * 사용자의 총 자산 조회 (계좌 잔액 + 세이프박스 잔액)
     */
    public BigDecimal getTotalAssets(String userEmail) {
        AccountVO account = accountMapper.findAccountByEmail(userEmail);
        SafeboxVO safebox = safeboxMapper.findSafeboxByEmail(userEmail);
        
        BigDecimal accountBalance = account != null ? account.getBalance() : BigDecimal.ZERO;
        BigDecimal safeboxBalance = safebox != null ? safebox.getBalance() : BigDecimal.ZERO;
        
        return accountBalance.add(safeboxBalance);
    }
}