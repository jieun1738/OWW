<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oww.oww1.mapper.PlanMapper">

  <resultMap id="PlanMap" type="com.oww.oww1.VO.PlanVO">
    <id     property="planNo"    column="plan_no"/>
    <result property="userEmail" column="user_email"/>
    <result property="packageNo" column="package_no"/>
    <result property="hall"      column="hall"/>
    <result property="studio"    column="studio"/>
    <result property="dress"     column="dress"/>
    <result property="makeup"    column="makeup"/>
  </resultMap>

  <select id="findPlansByUser" parameterType="string" resultMap="PlanMap">
    SELECT plan_no, user_email, NVL(package_no, 0) AS package_no,
           NVL(hall,0) AS hall, NVL(studio,0) AS studio, NVL(dress,0) AS dress, NVL(makeup,0) AS makeup
    FROM plan
    WHERE user_email = #{userEmail}
    ORDER BY plan_no DESC
  </select>

  <select id="findProductsByPlanNo" parameterType="int" resultType="com.oww.oww1.VO.ProductVO">
    SELECT p.product_no      AS productNo,
           p.product_name    AS productName,
           p.category        AS category,
           NVL(p.cost,0)     AS cost,
           p.address         AS address,
           p.description     AS description,
           p.img             AS img
    FROM plan pl
    JOIN product p ON p.product_no = pl.hall
    WHERE pl.plan_no = #{planNo} AND pl.hall IS NOT NULL
    UNION ALL
    SELECT p.product_no, p.product_name, p.category, NVL(p.cost,0), p.address, p.description, p.img
    FROM plan pl
    JOIN product p ON p.product_no = pl.studio
    WHERE pl.plan_no = #{planNo} AND pl.studio IS NOT NULL
    UNION ALL
    SELECT p.product_no, p.product_name, p.category, NVL(p.cost,0), p.address, p.description, p.img
    FROM plan pl
    JOIN product p ON p.product_no = pl.dress
    WHERE pl.plan_no = #{planNo} AND pl.dress IS NOT NULL
    UNION ALL
    SELECT p.product_no, p.product_name, p.category, NVL(p.cost,0), p.address, p.description, p.img
    FROM plan pl
    JOIN product p ON p.product_no = pl.makeup
    WHERE pl.plan_no = #{planNo} AND pl.makeup IS NOT NULL
  </select>

  <insert id="insertPlanDIY" parameterType="com.oww.oww1.VO.PlanVO">
    INSERT INTO plan (user_email, package_no, hall, studio, dress, makeup)
    VALUES (
      #{userEmail},
      9999,
      NULLIF(#{hall}, 0),
      NULLIF(#{studio}, 0),
      NULLIF(#{dress}, 0),
      NULLIF(#{makeup}, 0)
    )
  </insert>

</mapper>
