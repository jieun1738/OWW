<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oww.oww1.mapper.PlanMapper">

  <!-- 카멜 VO ↔ 스네이크 컬럼 매핑: AS 별칭으로 명시 -->
  <select id="findPlansByUser" resultType="com.oww.oww1.VO.PlanVO">
    SELECT
      plan_no    AS planNo,
      user_email AS userEmail,
      package_no AS packageNo,
      hall,
      studio,
      dress,
      makeup
    FROM plan
    WHERE user_email = #{userEmail}
    ORDER BY plan_no DESC
  </select>

  <select id="findProductsByPlanNo" resultType="com.oww.oww1.VO.ProductVO">
    SELECT
      p.product_no   AS productNo,
      p.product_name AS productName,
      p.category     AS category,
      p.cost         AS cost,
      p.address      AS address,
      p.description  AS description,
      p.img          AS img
    FROM product p
    WHERE p.product_no IN (
      SELECT hall   FROM plan WHERE plan_no = #{planNo}
      UNION SELECT studio FROM plan WHERE plan_no = #{planNo}
      UNION SELECT dress  FROM plan WHERE plan_no = #{planNo}
      UNION SELECT makeup FROM plan WHERE plan_no = #{planNo}
    )
    ORDER BY p.product_no
  </select>

  <insert id="insertPlanDIY">
    INSERT INTO plan (user_email, package_no, hall, studio, dress, makeup)
    VALUES (#{userEmail}, 9999,
            NULLIF(#{hall},   0),
            NULLIF(#{studio}, 0),
            NULLIF(#{dress},  0),
            NULLIF(#{makeup}, 0))
  </insert>

  <insert id="insertPlanFromPackage">
    INSERT INTO plan (user_email, package_no, hall, studio, dress, makeup)
    SELECT
      #{userEmail} AS user_email,
      pk.package_no,
      pk.hall,
      pk.studio,
      pk.dress,
      pk.makeup
    FROM package pk
    WHERE pk.package_no = #{packageNo}
  </insert>

  <!-- FK(app-level cascade): plan_progress -> plan 순서로 제거 -->
  <delete id="deleteProgressByUser">
    DELETE FROM plan_progress
     WHERE plan_no IN (SELECT plan_no FROM plan WHERE user_email = #{userEmail})
  </delete>

  <delete id="deleteProgressByPlanNo">
    DELETE FROM plan_progress WHERE plan_no = #{planNo}
  </delete>

  <delete id="deleteFinalByUser">
    DELETE FROM plan WHERE user_email = #{userEmail}
  </delete>

  <delete id="deleteFinalByPlanNo">
    DELETE FROM plan WHERE plan_no = #{planNo}
  </delete>

</mapper>
