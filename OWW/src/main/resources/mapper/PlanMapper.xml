<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wedding.oww.mapper.PlanMapper">

  <resultMap id="PlanMap" type="com.wedding.oww.vo.PlanVO">
    <id     property="planNo"    column="PLAN_NO"/>
    <result property="userEmail" column="USER_EMAIL"/>
    <result property="packageNo" column="PACKAGE_NO"/>
    <result property="hall"      column="HALL"/>
    <result property="studio"    column="STUDIO"/>
    <result property="dress"     column="DRESS"/>
    <result property="makeup"    column="MAKEUP"/>
  </resultMap>

  <insert id="insert" parameterType="com.wedding.oww.vo.PlanVO">
    INSERT INTO PLAN (
      USER_EMAIL, PACKAGE_NO, HALL, STUDIO, DRESS, MAKEUP
    ) VALUES (
      #{userEmail}, #{packageNo}, #{hall}, #{studio}, #{dress}, #{makeup}
    )
  </insert>

  <select id="findByUser" resultMap="PlanMap">
    SELECT * FROM PLAN WHERE USER_EMAIL = #{userEmail} ORDER BY PLAN_NO DESC
  </select>

  <select id="findById" resultMap="PlanMap">
    SELECT * FROM PLAN WHERE PLAN_NO = #{planNo}
  </select>

  <delete id="delete">
    DELETE FROM PLAN WHERE PLAN_NO = #{planNo}
  </delete>

  <select id="countByUser" resultType="int">
    SELECT COUNT(*) FROM PLAN WHERE USER_EMAIL = #{userEmail}
  </select>
  
  <!-- DIY 확정: 트리거 trg_plan_no 가 plan_no 자동 세팅 -->
  <insert id="insertDIY">
    INSERT INTO PLAN (USER_EMAIL, PACKAGE_NO, HALL, STUDIO, DRESS, MAKEUP)
    VALUES (#{email}, NULL, #{hall}, #{studio}, #{dress}, #{makeup})
  </insert>

  <!-- 패키지 확정: 패키지의 구성품까지 복사 저장 -->
  <insert id="insertPackage">
    INSERT INTO PLAN (USER_EMAIL, PACKAGE_NO, HALL, STUDIO, DRESS, MAKEUP)
    SELECT
      #{email} AS USER_EMAIL,
      p.PACKAGE_NO,
      p.HALL, p.STUDIO, p.DRESS, p.MAKEUP
    FROM PACKAGE p
    WHERE p.PACKAGE_NO = #{packageNo}
  </insert>

  <select id="findCommittedByUser" resultMap="PlanMap">
    SELECT PLAN_NO, USER_EMAIL, PACKAGE_NO, HALL, STUDIO, DRESS, MAKEUP
    FROM PLAN
    WHERE USER_EMAIL = #{email}
    ORDER BY PLAN_NO DESC
  </select>

  <select id="countCommittedByUser" resultType="int">
    SELECT COUNT(*)
    FROM PLAN
    WHERE USER_EMAIL = #{email}
  </select>
</mapper>
