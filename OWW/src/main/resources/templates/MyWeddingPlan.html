<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/totdesign}">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>myPage</title>
	<!-- tsparticles JS -->
	<script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
	<link th:href="@{/css/design.css}" rel="stylesheet" />
	<link th:href="@{/css/WeddingDIY.css}" rel="stylesheet" />
	<script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
	<script src="/js/payment.js" defer></script>
	<script>
		
		const urlParams = new URLSearchParams(window.location.search);
		    const amount = urlParams.get('amount');

		    if (amount) {
		        document.getElementById("paidAmountLabel").innerText = `결제 금액: ${amount}원`;
		    } else {
		        document.getElementById("paidAmountLabel").innerText = `결제 금액 정보를 불러오지 못했습니다.`;
		    }
		
		
		
		document.addEventListener('DOMContentLoaded', () => {
		const contractHallCheckbox = document.getElementById('contract_hall_ch');
	    const payHallCheckbox = document.getElementById('pay_hall');
	    const payButtons = document.querySelectorAll('.payBtn');
	    const otherButtons = document.querySelectorAll('.btn');

	    // 체크 여부 확인 함수
	    function toggleDisabled() {
	        if(payHallCheckbox.checked) {
	            payButtons.forEach(btn => btn.disabled = true);
	            otherButtons.forEach(btn => btn.disabled = true);
	            payHallCheckbox.disabled = true; // 체크 해제 방지
	        }
	    }

	    // 초기 로드 시 확인
	    toggleDisabled();

	    // 체크박스 클릭 이벤트 (체크 해제 방지용)
	    payHallCheckbox.addEventListener('click', (e) => {
	        if(payHallCheckbox.checked) {
	            e.preventDefault(); // 체크 해제 방지
	        }
	    });
		contractHallCheckbox.addEventListener('click', (e) => {
			        if(contractHallCheckbox.checked) {
			            e.preventDefault(); // 체크 해제 방지
			        }
			    });
	});
	</script>
	<style>
	

		.card-content {
			display: grid;
			grid-template-columns: 120px 1fr;
			gap: 15px;
			align-items: start;
		}
		
		.card-image {
			width: 100%;
			height: 100px;
			object-fit: cover;
			border-radius: 8px;
		}
		
		.card-details {
			display: grid;
			grid-template-columns: 1fr auto;
			gap: 15px;
			align-items: start;
		}
		
		.card-info h3 {
			margin: 0 0 8px 0;
			color: #FF6F61;
			font-size: 18px;
			font-weight: 600;
		}
		
		.card-price {
			color: #e91e63;
			font-size: 16px;
			font-weight: bold;
			margin: 5px 0;
		}
		
		.card-address {
			color: #666;
			font-size: 14px;
			margin: 5px 0;
		}
		
		.card-description {
			color: #777;
			font-size: 13px;
			line-height: 1.4;
			margin: 8px 0;
		}
		
		.card-controls {
			display: flex;
			flex-direction: column;
			gap: 10px;
			min-width: 150px;
		}
		
		.control-row {
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 14px;
		}
		
		.control-row input[type="checkbox"] {
			width: 16px;
			height: 16px;
		}
		
		.amount-input {
			width: 80px;
			padding: 4px 8px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 12px;
		}
		
		
		
		
		@media (max-width: 768px) {
			.card-content {
				grid-template-columns: 1fr;
				gap: 10px;
			}
			
			.card-details {
				grid-template-columns: 1fr;
				gap: 10px;
			}
			
			.card-controls {
				min-width: auto;
			}
		}
	</style>
</head>

<body>
	<th:block layout:fragment="header" th:insert="~{@{/fragments/header}}"></th:block>
	<th:block layout:fragment="nav" th:insert="~{@{/fragments/nav}}"></th:block>
	
	<!-- ========== Left Global Menu ========== -->
	<aside class="leftnav" aria-label="글로벌 메뉴">
		<div class="content">
			<img src="/img/user.png" alt="사용자 프로필" width="20px" height="20px" /><br>
			<span th:text="${totalBudget.user_email}">사용자 이메일</span>
			<div class="progress-container">
				<div class="progress-bar" th:style="'width:' + ${contract_progress}+'%'"></div>
			</div>
		</div>
		<div class="sidebar">
			<h2>메뉴</h2>
			
			<a class="ln-item" href="/wedding-plan" aria-label="나의 웨딩플랜 보기">
				<span>my 웨딩플랜</span><span class="ln-dot"></span>
			</a><br>
			<a class="ln-item" href="/budget-setting" aria-label="예산 설정하기">
				<span>예산설정</span><span class="ln-dot"></span>
			</a><br>
			<a class="ln-item" href="/consumption-info" aria-label="소비정보 조회하기">
				<span>소비정보 조회</span><span class="ln-dot"></span>
			</a><br>
			<a class="ln-item" href="/savings" aria-label="차곡차곡 금고 관리">
				<span>차곡차곡 금고</span><span class="ln-dot"></span>
			</a><br>
			<a class="ln-item" href="/payment-history" aria-label="미니스토어 결제내역 보기">
				<span>미니스토어 결제 내역</span><span class="ln-dot"></span>
			</a>
		</div>
	</aside>

	<!-- ========== Main ========== -->
	<main class="main">
	

		<!-- 웨딩 상품 카드들 -->
		<section class="cards" aria-live="polite">
			<div class="smalltitle">my 웨딩 플랜</div>
			<div class="progress-card">
				<div class="progress-item">
					<h4>결혼 준비 진행율</h4>
					<div class="progress-container">
						<div class="progress-bar" th:style="'width:' + ${contract_progress}+'%'">
							<span th:text="${contract_progress} + '%'"></span>
						</div>
					</div>
				</div>
				<div class="progress-item">
					<h4>예산 사용율</h4>
					<div class="progress-container">
						<div class="progress-bar" th:style="'width:' + ${paid_progress}+'%'">
							<span th:text="${paid_progress} + '%'"></span>
						</div>
					</div>
				</div>
			</div>
			<div class="total-card">				
				<h3 th:if="${discount != 0}">💡 저장된 상품은 패키지 상품으로 <span th:text="|${discount}%|"></span> 할인 적용됩니다.</h3>
				<h5 th:if="${discount != 0}">⚠️ 개별항목 수정시 할인적용이 불가능 합니다.</h5>
			<form class="total">
				<div class="total">총 예상 견적: <span th:text="${total_cost}"style="text-decoration: underline;"></span> 원
					<input type="hidden" name="cost" th:value="${total_cost}">
					<input type="hidden" name="product_name" th:value="'전체 플랜 결제'">
					<button type="button" class="payBtn">전체 항목 결제하기</button>				
			
				</div>
			</form>
			</div>
			
			<!-- 웨딩홀 카드 -->
			<form th:action="@{/saveprogress.do}">
			<article class="card-dash">
				
				<div class="card-content">
					<img th:src="@{'/img/' + ${hallInfo.img}}" alt="웨딩홀 이미지" class="card-image" />
					<div class="card-details">
						<div class="card-info">
							<h3 th:text="${hallInfo.product_name}">웨딩홀명</h3>
							<div class="card-price" th:text="${hallInfo.cost}">가격</div>
							<div class="card-address" th:text="${hallInfo.address}">주소</div>
							<div class="card-description" th:text="${hallInfo.description}">설명</div>
						</div>
						<div class="card-controls">
							<div class="control-row">
								<input type="checkbox" name="contract_hall_ch" id="contract_hall_ch"  th:field="*{planprog.contract_hall_ch}" />
								<label for="hall_contract">계약완료</label>
							</div>
							<div class="control-row">
								<input type="checkbox" class="check_box" name="pay_hall" id="pay_hall"  th:field="*{planprog.pay_hall_ch}"/>
								<label for="hall_paid">결제완료</label>
								<label id="paidAmountLabel"></label>
								<form class="pay">		
										<input type="hidden" name="cost" th:value="${hallInfo.cost}">
										<input type="hidden" name="product_name" th:value="${hallInfo.product_name}">
										<button type="button" class="payBtn">항목 결제하기</button>
								</form>
								</div>
							<button type="button" class="btn" onclick="location.href='planner/WeddingDIY'">
								다른 업체 보러가기
							</button>
						</div>
					</div>
				</div>
			</article>

			<!-- 스튜디오 카드 -->
			<article class="card-dash">
				<div class="card-content">
					<img th:src="@{'/img/' + ${studioInfo.img}}" alt="스튜디오 이미지" class="card-image" />
					<div class="card-details">
						<div class="card-info">
							<h3 th:text="${studioInfo.product_name}">스튜디오명</h3>
							<div class="card-price" th:text="${studioInfo.cost}">가격</div>
							<div class="card-address" th:text="${studioInfo.address}">주소</div>
							<div class="card-description" th:text="${studioInfo.description}">설명</div>
						</div>
						<div class="card-controls">
							<div class="control-row">
								<input type="checkbox" name="contract_stud_ch" id="contract_stud_ch" th:field="*{planprog.contract_stud_ch}" />
								<label for="studio_contract">계약완료</label>
							</div>
							<div class="control-row">
								<input type="checkbox"  class="check_box" name="pay_stud" id="pay_stud" th:field="*{planprog.pay_stud_ch}"/>
								<label for="studio_paid">결제완료</label>
								<input type="number" name="pay_stud" class="amount-input" th:value="${planprog.pay_stud}" />
							</div>
							<button type="button" class="btn" onclick="location.href='makeplan.do'">
								업데이트
							</button>
						</div>
					</div>
				</div>
			</article>

			<!-- 드레스 카드 -->
			<article class="card-dash">
				<div class="card-content">
					<img th:src="@{'/img/' + ${dressInfo.img}}" alt="드레스 이미지" class="card-image" />
					<div class="card-details">
						<div class="card-info">
							<h3 th:text="${dressInfo.product_name}">드레스명</h3>
							<div class="card-price" th:text="${dressInfo.cost}">가격</div>
							<div class="card-address" th:text="${dressInfo.address}">주소</div>
							<div class="card-description" th:text="${dressInfo.description}">설명</div>
						</div>
						<div class="card-controls">
							<div class="control-row">
								<input type="checkbox"  class="check_box" name="contract_dres_ch" id="contract_dres_ch" th:field="*{planprog.contract_dres_ch}"/>
								<label for="dress_contract">계약완료</label>
							</div>
							<div class="control-row">
								<input type="checkbox" name="pay_dres" id="dress_paid" th:field="*{planprog.pay_dres_ch}"/>
								<label for="dress_paid">결제완료</label>
								<label id="paidAmountLabel"></label>
								<form class="pay">
									<input type="hidden" name="cost" th:value="${dressInfo.cost}">
									<input type="hidden" name="product_name" th:value="${dressInfo.product_name}">
									<button type="button" class="payBtn">항목 결제하기</button>
								</form>
								</div>
								<button type="button" class="btn" onclick="location.href='makeplan.do'">
									업데이트
							</button>
						</div>
					</div>
				</div>
			</article>

			<!-- 메이크업 카드 -->
			<article class="card-dash">
				<div class="card-content">
					<img th:src="@{'/img/' + ${makeupInfo.img}}" alt="메이크업 이미지" class="card-image" />
					<div class="card-details">
						<div class="card-info">
							<h3 th:text="${makeupInfo.product_name}">메이크업샵명</h3>
							<div class="card-price" th:text="${makeupInfo.cost}">가격</div>
							<div class="card-address" th:text="${makeupInfo.address}">주소</div>
							<div class="card-description" th:text="${makeupInfo.description}">설명</div>
						</div>
						<div class="card-controls">
							<div class="control-row">
								<input type="checkbox" name="contract_make_ch" id="contract_make_ch" th:field="*{planprog.contract_make_ch}"/>
								<label for="makeup_contract">계약완료</label>
							</div>
							<div class="control-row">
								<input type="checkbox"  class="check_box" name="pay_make" id="makeup_paid" th:field="*{planprog.pay_make_ch}"/>
								<label for="makeup_paid">결제완료</label>
								<input type="number" name="pay_make" class="amount-input" th:value="${planprog.pay_make}" />
							</div>
							<button type="button" class="btn" onclick="location.href='makeplan.do'">
								업데이트
							</button>
						</div>
					</div>
				</div>
			</article>
			
			<button type="submit" class="btn">저장</button>											
			</form>							
		</section>
	</main>

	<th:block layout:fragment="footer" th:insert="~{@{/fragments/footer}}"></th:block>
</body>

</html>