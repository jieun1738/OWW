<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title th:text="${title} ?: '차곡차곡 금고'">차곡차곡 금고</title>

  <!-- 공통 CSS -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="stylesheet" href="/css/safe_box.css">

  <!-- 차트 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
</head>
<body>
  <!-- 상단바: 로고/로그아웃 버튼 -->
  <header class="topbar">
    <div class="topbar-inner">
      <a class="btn-ghost" th:href="@{/}">로고</a>
      <a class="btn-primary" th:href="@{/logout}">로그아웃</a>
    </div>
  </header>

  <  <!-- 사이드바 공통 레이아웃 호출 -->
  <div th:replace="~{base :: layout(user=${user}, active='safe', progress=${progressPercent})}">
    <!-- 본문 조각 -->
    <div th:fragment="content">
      <link rel="stylesheet" href="/css/safe_box.css">

      <h1 class="page-title">차곡차곡 금고</h1>


      <!-- 목표 달성율 카드 -->
  <div class="progress">
  <span th:style="|width:${progressPercent}%|"
        th:text="|${progressPercent}%|">0%</span>
</div>


        <div class="goal-info">
          <div class="row">
            <span class="label">목표금액:</span>
            <span class="value"
                  th:text="|${goal != null ? #numbers.formatInteger(goal.targetAmount,3,'COMMA') : 0}원|">0원</span>
          </div>
          <div class="row">
            <span class="label">저축액:</span>
            <span class="value violet"
                  th:text="|${goal != null ? #numbers.formatInteger(goal.savedAmount,3,'COMMA') : 0}원|">0원</span>
          </div>
          <div class="row">
            <span class="label">잔여금액:</span>
            <span class="value"
                  th:with="remain=${goal != null ? (goal.targetAmount - goal.savedAmount) : 0}"
                  th:text="|${#numbers.formatInteger(remain,3,'COMMA')}원|">0원</span>
          </div>
        </div>
      </section>

      <!-- 그래프 카드 -->
      <section class="card">
        <div class="tabs">
          <button id="tab-daily" class="tab active" type="button">일별 저금율</button>
          <button id="tab-monthly" class="tab" type="button">월별 저금율</button>
        </div>

        <div class="chart-block">
          <div class="chart-caption">0 원 ▽</div>
          <div class="chart-wrap"><canvas id="savingChart" aria-label="저축 추이 그래프"></canvas></div>
          <div class="baseline"></div>
        </div>

        <div class="progress titled">
          <div class="title">저금 성공률</div>
          <span id="successBar">0%</span>
        </div>
      </section>
    </main>
  </div>

  <!-- 서버 값 주입 -->
  <script th:inline="javascript">
    const targetAmount = /*[[${goal != null ? goal.targetAmount : 0}]]*/ 0;
    const savedAmount  = /*[[${goal != null ? goal.savedAmount  : 0}]]*/ 0;
  </script>

  <!-- 차트 스크립트 -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      let savingChart;

      function renderChart(labels, data){
        const ctx = document.getElementById('savingChart').getContext('2d');
        if (savingChart) savingChart.destroy();
        savingChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: '저축금액',
              data,
              pointRadius: 3,
              tension: .35
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false }},
              y: { beginAtZero: true }
            }
          }
        });
      }

      // 샘플 데이터
      const sampleDaily   = [15,12,14,18,25,22,27,26,24,28,32,31,30,29,30,33,31,35,36,34,32,33,36,35,34,37,39,38,36,37,40].map(v=>v*10000);
      const sampleMonthly = [120,130,110,150,160,170,180,190,175,185,195,210].map(v=>v*10000);

      function updateSuccessBar(arr){
        if (!arr || arr.length === 0) {
          document.getElementById('successBar').style.width = '0%';
          document.getElementById('successBar').textContent = '0%';
          return;
        }
        const unit   = Math.max(1, Math.round((targetAmount || 0) / arr.length));
        const exceed = arr.filter(v => v >= unit).length;
        const ratio  = Math.min(100, Math.round((exceed / arr.length) * 100));
        const bar    = document.getElementById('successBar');
        bar.style.width = ratio + '%';
        bar.textContent = ratio + '%';
      }

      function toDaily(){
        document.getElementById('tab-daily').classList.add('active');
        document.getElementById('tab-monthly').classList.remove('active');
        const days = 31; // 시각화 고정(필요시 현재 달 계산 로직로 교체)
        const labels = Array.from({length: days}, (_,i)=> `${i+1}일`);
        const data   = sampleDaily.slice(0, days);
        renderChart(labels, data);
        updateSuccessBar(data);
      }

      function toMonthly(){
        document.getElementById('tab-monthly').classList.add('active');
        document.getElementById('tab-daily').classList.remove('active');
        const labels = Array.from({length:12}, (_,i)=> `${i+1}월`);
        renderChart(labels, sampleMonthly);
        updateSuccessBar(sampleMonthly);
      }

      document.getElementById('tab-daily').addEventListener('click', toDaily);
      document.getElementById('tab-monthly').addEventListener('click', toMonthly);

      // 최초 진입: 일별
      toDaily();
    });
  </script>
</body>
</html>
